<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<title>Connexion ‚Äî CISMIC</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  * { box-sizing:border-box; font-family:'Inter',sans-serif; margin:0; padding:0; }
  body {
    background: linear-gradient(135deg,#004aad,#d32f2f);
    display:flex; justify-content:center; align-items:center;
    height:100vh; color:#fff;
  }
  .login-box {
    background:#ffffffee; color:#222;
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.3);
    padding:40px 50px; width:100%; max-width:420px; text-align:center;
  }
  .login-box img { height:100px; margin-bottom:15px; }
  .login-box h2 { font-size:24px; color:#004aad; margin-bottom:20px; font-weight:700; }
  .login-box input, select {
    width:100%; padding:12px; margin:8px 0;
    border:1px solid #ccc; border-radius:8px; font-size:15px;
  }
  .login-box button {
    width:100%; padding:12px; background:#d32f2f;
    color:#fff; border:none; border-radius:8px; font-size:16px;
    font-weight:600; cursor:pointer; transition:background .2s;
  }
  .login-box button:hover { background:#b71c1c; }
  .muted { font-size:13px; color:#555; margin-top:10px; }
  .field-label { text-align:left; font-size:14px; font-weight:600; color:#004aad; margin-top:4px; }
  .muted a { color:#004aad; text-decoration:underline; cursor:pointer; }

  /* --- Modale Mentions l√©gales --- */
  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 9999;
  }
  .modal{
    width: 100%;
    max-width: 560px;
    background: #fff;
    color: #222;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    padding: 18px 18px 14px;
    text-align: left;
  }
  .modal h3{
    margin: 0 0 10px 0;
    color:#004aad;
    font-size: 18px;
  }
  .modal p{
    margin: 10px 0;
    font-size: 14px;
    line-height: 1.45;
    white-space: pre-line;
  }
  .modal .actions{
    display:flex;
    justify-content: flex-end;
    margin-top: 12px;
  }
  .modal .close-btn{
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    background: #004aad;
    color: #fff;
    cursor: pointer;
    font-weight: 600;
  }
  .modal .close-btn:hover{
    filter: brightness(.92);
  }
</style>
</head>
<body>

<div class="login-box">
  <img src="https://i.postimg.cc/LsB40JQq/logo-cismic.png" alt="Logo SDIS 30">
  <h2>Connexion ‚Äî CISMIC</h2>

  <input id="matricule" type="text" placeholder="Matricule" autocomplete="username">

  <!-- CIS √† choisir si l'utilisateur en a plusieurs -->
  <div id="cis-container" style="display:none;">
    <div class="field-label">CIS</div>
    <select id="cisSelect"></select>
  </div>

  <input id="password" type="password" placeholder="Mot de passe" autocomplete="current-password">
  <button id="loginBtn" onclick="login()">Se connecter</button>

  <p class="muted">Mot de passe provisoire : fourni par l‚Äôadministrateur</p>
  <p class="muted"><a onclick="forgotWithQuestion(event)">Mot de passe oubli√© ? R√©pondre √† ma question</a></p>

  <p class="muted"><strong>¬© 2025 CISMIC ‚Äî Marque d√©pos√©e</strong></p>
  <p class="muted"><strong>Tous droits r√©serv√©s</strong></p>
  <p class="muted"><a href="#" onclick="openMentions(event)">Mentions l√©gales</a></p>
</div>

<!-- Modale Mentions l√©gales -->
<div id="mentionsModal" class="modal-overlay" onclick="closeMentions()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Mentions l√©gales</h3>
    <p>
CISMIC est une marque d√©pos√©e aupr√®s de l‚ÄôINPI.

L‚Äôensemble du site (structure, textes, codes sources, graphismes, logos)
est prot√©g√© par le droit d‚Äôauteur.
Toute reproduction, repr√©sentation, modification ou adaptation,
totale ou partielle, sans autorisation √©crite pr√©alable,
est strictement interdite.

Toute utilisation non autoris√©e pourra faire l‚Äôobjet de poursuites.
    </p>
    <div class="actions">
      <button class="close-btn" type="button" onclick="closeMentions()">Fermer</button>
    </div>
  </div>
</div>

<!-- üîå Firebase + Firestore + cloud-storage -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="cloud-storage.js"></script>

<script>
const INDEX_PATH = "index.html";

/* ===================== SHA-256 (compat anciens comptes) ===================== */
async function sha256Hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const buf = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ===================== PBKDF2 (compat Admin actuel) ===================== */
function b64ToBytes(b64){
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
  return out;
}
function bytesToB64(bytes){
  let bin = "";
  bytes.forEach(b=>bin += String.fromCharCode(b));
  return btoa(bin);
}
async function pbkdf2HashB64(password, saltB64, iterations=150000){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    enc.encode(password),
    "PBKDF2",
    false,
    ["deriveBits"]
  );
  const salt = b64ToBytes(saltB64);
  const bits = await crypto.subtle.deriveBits(
    { name:"PBKDF2", salt, iterations, hash:"SHA-256" },
    keyMaterial,
    256
  );
  return bytesToB64(new Uint8Array(bits));
}

/* ===================== Question secr√®te (PBKDF2 Hex, comme ton ancien login) ===================== */
async function pbkdf2HashHex(secret, saltHex, iterations=100000){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(secret), {name:"PBKDF2"}, false, ["deriveBits"]);
  const salt = new Uint8Array(saltHex.match(/.{1,2}/g).map(h=>parseInt(h,16)));
  const bits = await crypto.subtle.deriveBits({name:"PBKDF2", hash:"SHA-256", salt, iterations}, keyMaterial, 256);
  return Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function genSaltHex(n=16){
  const b=new Uint8Array(n);
  crypto.getRandomValues(b);
  return Array.from(b).map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* ===================== Politique MDP (robuste) ===================== */
function checkPasswordPolicy(pwd){
  const errors = [];
  if (!pwd || pwd.length < 10) errors.push("au moins 10 caract√®res");
  if (!/[A-Z]/.test(pwd)) errors.push("au moins 1 majuscule");
  if (!/[^A-Za-z0-9\s]/.test(pwd)) errors.push("au moins 1 caract√®re sp√©cial (ex: ! ? @ #)");
  return errors;
}
async function promptNewPassword(){
  while(true){
    const newPwd = prompt("Nouveau mot de passe (10 caract√®res min, 1 majuscule, 1 caract√®re sp√©cial) :");
    if(newPwd === null) return null;

    const confirmPwd = prompt("Confirmez le mot de passe :");
    if(confirmPwd === null) return null;

    if(newPwd !== confirmPwd){
      alert("Les mots de passe ne correspondent pas.");
      continue;
    }

    const errs = checkPasswordPolicy(newPwd);
    if(errs.length){
      alert("Mot de passe invalide :\n- " + errs.join("\n- "));
      continue;
    }
    return newPwd;
  }
}

/* ===================== Questions secr√®tes ===================== */
const SECRET_QUESTIONS = [
  "Quel est le nom de votre premier animal de compagnie ?",
  "Dans quelle ville √™tes-vous n√©(e) ?",
  "Quel √©tait le nom de votre √©cole primaire ?",
  "Quel est votre film pr√©f√©r√© ?",
  "Quel est le pr√©nom de votre meilleur ami d‚Äôenfance ?",
  "Quel est votre plat pr√©f√©r√© ?",
  "Autre : je saisis ma propre question"
];
function selectSecretQuestion(){
  const menu = SECRET_QUESTIONS.map((q,i)=>`${i+1}. ${q}`).join("\n");
  while(true){
    const ans = prompt("Choisissez une question (entrez le num√©ro) :\n\n"+menu);
    if(ans===null) return null;
    const idx = parseInt(ans,10);
    if(!Number.isInteger(idx) || idx<1 || idx>SECRET_QUESTIONS.length){
      alert("Num√©ro invalide.");
      continue;
    }
    const picked = SECRET_QUESTIONS[idx-1];
    if(picked.startsWith("Autre")){
      let custom = "";
      do{
        custom = prompt("Saisissez VOTRE question (au moins 10 caract√®res) :") || "";
        if(custom===null) return null;
      }while(custom.trim().length<10);
      return custom.trim();
    }
    return picked;
  }
}

/* ===================== Normalisation user ===================== */
function normalizeUser(uRaw){
  const u = JSON.parse(JSON.stringify(uRaw||{}));

  if (Array.isArray(u.cis)) {
    const primary = u.cis[0] || "";
    const rest = (u.cis.slice(1)||[]).map(c=>({ cis:c, role: u.role || "agent" }));
    u.cis = { primary, secondaries: rest };
    u.role = u.role || "agent";
  } else if (typeof u.cis === "string") {
    u.cis = { primary: u.cis, secondaries: [] };
    u.role = u.role || "agent";
  } else {
    u.cis = u.cis || { primary:"", secondaries:[] };
    u.role = u.role || "agent";
  }

  const seen = new Set();
  const primLC = (u.cis.primary||"").toLowerCase();
  u.cis.secondaries = (u.cis.secondaries||[]).filter(s=>{
    if(!s || !s.cis) return false;
    const k=s.cis.toLowerCase();
    if(k===primLC || seen.has(k)) return false;
    seen.add(k); return true;
  });

  return u;
}

/* ===================== Cloud load/save ===================== */
async function loadUser(matricule){
  const key = "csver_user_" + matricule;

  // 1) Cloud d'abord
  const cloudUser = await cloudGetJSON(key, null);
  if (cloudUser) {
    localStorage.setItem(key, JSON.stringify(cloudUser)); // cache local
    return cloudUser;
  }

  // 2) Fallback local
  const data = localStorage.getItem(key);
  return data ? JSON.parse(data) : null;
}
async function saveUser(matricule, userObj){
  const key = "csver_user_" + matricule;
  localStorage.setItem(key, JSON.stringify(userObj));
  await cloudSetJSON(key, userObj);
}

/* ===================== Pr√©charger CIS ===================== */
document.getElementById("matricule").addEventListener("blur", preloadCis);
document.getElementById("matricule").addEventListener("input", (e)=>{
  if(!e.target.value.trim()){
    document.getElementById("cis-container").style.display="none";
    const sel = document.getElementById("cisSelect");
    sel.innerHTML="";
    sel.disabled = false;
  }
});

async function preloadCis(){
  const matricule = document.getElementById("matricule").value.trim();
  const cisWrap = document.getElementById("cis-container");
  const sel = document.getElementById("cisSelect");

  if(!matricule){
    cisWrap.style.display = "none";
    sel.innerHTML = "";
    sel.disabled = false;
    return;
  }

  const userData = await loadUser(matricule);
  if(!userData){
    cisWrap.style.display = "none";
    sel.innerHTML = "";
    sel.disabled = false;
    return;
  }

  const user = normalizeUser(userData);

  const entries = [];
  if (user.cis.primary) entries.push({ cis: user.cis.primary, role: user.role, kind: "principal" });
  (user.cis.secondaries||[]).forEach(s=> entries.push({ cis: s.cis, role: s.role || "agent", kind: "secondaire" }));

  if(entries.length === 0){
    cisWrap.style.display = "none";
    sel.innerHTML = "";
    sel.disabled = false;
    return;
  }

  sel.innerHTML = "";
  entries.forEach(e=>{
    const opt = document.createElement("option");
    opt.value = e.cis;
    opt.textContent = e.kind === "principal" ? `${e.cis} (principal)` : `${e.cis} (secondaire)`;
    opt.dataset.role = e.role;
    opt.dataset.kind = e.kind;
    sel.appendChild(opt);
  });

  sel.disabled = (entries.length === 1);
  cisWrap.style.display = "block";
}

/* ===================== V√©rification mot de passe ===================== */
async function verifyPassword(user, password){
  const pwd = (password || "").trim();

  // ‚úÖ Nouveau format (Admin actuel) : PBKDF2 base64
  if(user && user.kdf === "pbkdf2" && user.salt && user.hash && user.iters){
    const calc = await pbkdf2HashB64(pwd, user.salt, user.iters);
    return calc === user.hash;
  }

  // ‚úÖ Ancien format : SHA-256 hex
  if(user && user.hash){
    const h = await sha256Hex(pwd);
    return h === user.hash;
  }

  return false;
}

/* ===================== Premi√®re connexion = pas de question secr√®te ===================== */
async function firstLoginForceChange(matricule, user){
  // √Ä ce stade, le provisoire est OK -> on force MDP robuste + question secr√®te
  const newPwd = await promptNewPassword();
  if(newPwd === null) return false;

  const q = selectSecretQuestion();
  if(!q) return false;

  const a = prompt("R√©ponse (respectez majuscules/espaces ‚Äî vide accept√©) :");
  if(a === null) return false;

  const saltQ = genSaltHex();
  const hashQ = await pbkdf2HashHex(a, saltQ, 100000);

  user.secret_question = { q, hash: hashQ, salt: saltQ, iters: 100000 };

  // ‚úÖ On repasse en ‚Äúmdp normal‚Äù SHA-256 (compat historique)
  user.hash = await sha256Hex(newPwd);
  delete user.kdf;
  delete user.salt;
  delete user.iters;

  await saveUser(matricule, user);

  alert("Mot de passe mis √† jour ‚úÖ. Vous pouvez vous connecter.");
  return true;
}

/* ===================== LOGIN ===================== */
async function login(){
  const matricule = document.getElementById("matricule").value.trim();
  const password  = document.getElementById("password").value.trim();

  if(!matricule || !password){
    alert("Merci de remplir les champs matricule et mot de passe.");
    return;
  }

  const userData = await loadUser(matricule);
  if(!userData){
    alert("Matricule inconnu.");
    return;
  }

  let user = normalizeUser(userData);

  // ‚úÖ Premi√®re connexion / apr√®s reset Admin : pas de question secr√®te => provisoire
  if(!user.secret_question || !user.secret_question.q){
    const ok = await verifyPassword(user, password);
    if(!ok){
      alert("Mot de passe incorrect.");
      return;
    }
    const done = await firstLoginForceChange(matricule, user);
    if(done) return;
    return;
  }

  // ‚úÖ Connexion normale
  const ok = await verifyPassword(user, password);
  if(!ok){
    alert("Mot de passe incorrect.");
    return;
  }

  // Choix CIS
  const entries = [];
  if (user.cis.primary) entries.push({ cis:user.cis.primary, role:user.role, kind:"principal" });
  (user.cis.secondaries||[]).forEach(s=> entries.push({ cis:s.cis, role:s.role||"agent", kind:"secondaire" }));

  if(entries.length === 0){
    alert("Aucun CIS associ√© √† ce compte. Contacte un administrateur.");
    return;
  }

  const sel = document.getElementById("cisSelect");
  let chosen = entries[0];

  if(entries.length > 1){
    if(!sel || sel.options.length === 0){
      alert("Merci de choisir ton CIS.");
      await preloadCis();
      return;
    }
    const opt = sel.selectedOptions[0];
    chosen = {
      cis: sel.value,
      role: opt?.dataset?.role || "agent",
      kind: opt?.dataset?.kind || "principal"
    };
  }

  localStorage.setItem("csver_session", JSON.stringify({
    matricule: user.matricule,
    prenom: user.prenom || "",
    nom: user.nom || "",
    cis: chosen.cis,
    role: chosen.role,
    cis_kind: chosen.kind,
    cis_all: user.cis
  }));

  const displayName = (user.prenom ? user.prenom+" " : "") + (user.nom || user.matricule);
  alert(`Bienvenue ${displayName} (${chosen.role}) ‚Äî CIS : ${chosen.cis}`);
  window.location.href = INDEX_PATH;
}

/* ===================== Mot de passe oubli√© ===================== */
async function forgotWithQuestion(ev){
  ev && ev.preventDefault();

  const matricule = prompt("Votre matricule :");
  if(!matricule) return;

  const userData = await loadUser(matricule);
  if(!userData){
    alert("Matricule inconnu.");
    return;
  }

  let user = normalizeUser(userData);

  if(!user.secret_question || !user.secret_question.q){
    alert("Aucune question secr√®te d√©finie pour ce compte. Contactez un administrateur.");
    return;
  }

  alert("Question secr√®te :\n\n" + user.secret_question.q);
  const ans = prompt("Votre r√©ponse (retapez exactement votre phrase ‚Äî vide accept√©) :");
  if(ans === null) return;

  const h = await pbkdf2HashHex(ans, user.secret_question.salt, user.secret_question.iters || 100000);
  if(h !== user.secret_question.hash){
    alert("R√©ponse incorrecte.");
    return;
  }

  const newPwd = await promptNewPassword();
  if(newPwd === null) return;

  user.hash = await sha256Hex(newPwd);
  delete user.kdf;
  delete user.salt;
  delete user.iters;

  await saveUser(matricule, user);
  alert("Mot de passe r√©initialis√©. Vous pouvez vous connecter.");
}

/* --- Mentions l√©gales (modale) --- */
function openMentions(ev){
  ev && ev.preventDefault();
  document.getElementById("mentionsModal").style.display = "flex";
}
function closeMentions(){
  document.getElementById("mentionsModal").style.display = "none";
}
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeMentions();
});
</script>
</body>
</html>
