<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
<title>CISMIC</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}

body{
  background:linear-gradient(135deg,#1d3f73 0%,#d43d3d 100%);
  min-height:100vh;display:flex;flex-direction:column;color:#222;
}

/* HEADER */
header{
  background:#fff;display:flex;align-items:center;justify-content:space-between;
  padding:18px 40px;box-shadow:0 4px 12px rgba(0,0,0,.15);
}
header img{height:70px;}
header .title-block{text-align:center;flex:1;}
header h1{font-size:30px;color:#0d2b52;font-weight:700;}
header p{font-size:15px;color:#444;margin-top:6px;font-weight:600;}
.logout-btn{
  background:#b71c1c;color:#fff;font-weight:600;border:none;
  padding:10px 26px;border-radius:30px;font-size:15px;cursor:pointer;transition:.25s;
}
.logout-btn:hover{background:#8b0000;}

/* === MENU === */
nav.menu-bar {
  background:#0d2b52;
  display:flex;
  justify-content:center;
  position:relative;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}
nav.menu-bar ul { list-style:none; display:flex; gap:30px; flex-wrap:wrap; padding:0; }
nav.menu-bar ul li { position:relative; }
nav.menu-bar a {
  display:block;color:#fff;font-weight:600;padding:14px 18px;
  text-decoration:none;transition:0.25s;border-radius:8px;
}
nav.menu-bar > ul > li > a:hover { background:#b71c1c; }

/* Sous-menu */
nav.menu-bar ul li ul {
  display:none;position:absolute;top:100%;left:0;background:#fff;
  border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);
  min-width:220px;z-index:1000;flex-direction:column;overflow:hidden;
}
nav.menu-bar ul li:hover ul { display:flex; }
nav.menu-bar ul li ul li a {
  color:#0d2b52;padding:12px 16px;border-bottom:1px solid #eee;border-radius:0;
}
nav.menu-bar ul li ul li:last-child a { border-bottom:none; }
nav.menu-bar ul li ul li a:hover { background:#f4f4f4;color:#b71c1c; }

/* ‚îÄ‚îÄ Bandeau m√©t√©o fin sous le menu (centr√©) ‚îÄ‚îÄ */
.meteo-banner{
  display:flex; flex-direction:column; align-items:center; gap:6px;
  padding:10px 16px;
  background:rgba(255,255,255,0.9);
  color:#0d2b52;
  border-bottom:1px solid rgba(0,0,0,.08);
  box-shadow:0 2px 6px rgba(0,0,0,.06) inset;
  text-align:center;
}
.meteo-row{
  display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;
}
.meteo-row.small{ font-size:13px; color:#0d2b52; }
.meteo-banner .emoji{ font-size:18px; line-height:1; }
.meteo-banner .temp{ font-size:18px; font-weight:800; }
.meteo-banner .desc{ font-size:14px; color:#333; }

/* LAYOUT ‚Äî 3 colonnes : formation (gauche) + v√©hicules (centre) + main courante (droite) */
main{
  flex:1;max-width:2000px;margin:40px auto;padding:0 40px;
  display:grid;gap:28px;
  grid-template-columns: 380px minmax(0,1.3fr) 380px;
  align-items:stretch;
}
@media (max-width: 1280px){
  main{ grid-template-columns: 320px 1fr; }
  #journal-panel{ grid-column: 1 / -1; }
}
@media (max-width: 980px){
  main{ grid-template-columns: 1fr; }
}

/* SECTIONS / PANELS */
.section,
.panel{
  border-radius:16px;padding:24px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  display:flex;flex-direction:column;gap:18px;
  backdrop-filter:blur(10px);
  color:#1e1e1e;
  background:rgba(255,255,255,0.9);
  min-height:0; /* important */
}
.section.vehicules{background:rgba(240,250,245,0.92);}

.section-header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
.section h2{
  font-size:22px;font-weight:700;margin-bottom:5px;
  color:#0d2b52;border-left:6px solid #b71c1c;padding-left:12px;
}

/* BOUTONS */
.grid{
  display:grid;gap:18px;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
}
.btn{
  border:none;border-radius:12px;padding:18px 20px;cursor:pointer;
  color:#fff;font-size:16px;font-weight:600;text-align:center;
  transition:all .25s ease;background:#1a73e8;
  box-shadow:0 3px 8px rgba(0,0,0,.12);
}
.btn:hover{transform:translateY(-3px);box-shadow:0 6px 14px rgba(0,0,0,.2);background:#155bb5;}
.print-btn{
  background:#6a1b9a;color:#fff;font-weight:600;border:none;border-radius:10px;
  padding:8px 16px;cursor:pointer;transition:0.25s;font-size:15px;
}
.print-btn:hover{background:#4a0e6a;}

/* VEHICULES ‚Äî 4 par ligne */
#vehicule-grid{
  display:grid;
  gap:14px;
  grid-template-columns:repeat(4, minmax(0,1fr));
  grid-auto-rows:78px;
  align-items:stretch;
  min-height:0;
}
@media (max-width:1280px){ #vehicule-grid{ grid-template-columns:repeat(3,1fr); } }
@media (max-width:980px) { #vehicule-grid{ grid-template-columns:repeat(2,1fr); } }
@media (max-width:560px) { #vehicule-grid{ grid-template-columns:1fr; } }

.vehicule-card{
  border-radius:10px;
  padding:10px 12px;
  text-align:center;
  color:#fff;
  font-weight:700;
  font-size:16px;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
  cursor:pointer;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  line-height:1.1;
}
.vehicule-card small{
  font-size:13px;
  opacity:0.95;
  margin-top:2px;
  line-height:1.1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

  #materiel-grid{
  display:grid;
  gap:12px;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
}
#materiel-grid .vehicule-card{
  cursor:pointer;
}


/* üìò Main courante Formation (gauche) ‚Äì m√™me look que la droite */
#formation-panel.panel{ overflow:hidden; padding:0; }
#formation-header{
  padding:14px 16px;
  background:#0d2b52;
  color:#fff;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
/* Bouton + dans le header des consignes */
.header-plus-btn{
  border:none;
  border-radius:999px;
  width:28px;
  height:28px;
  font-size:18px;
  font-weight:700;
  line-height:1;
  cursor:pointer;
  background:#b71c1c;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}
.header-plus-btn:hover{
  background:#8b0000;
}

#formation-list{
  padding:12px 14px;
  overflow:auto;max-height:100%;
  display:flex;flex-direction:column;gap:10px;
}

/* Colonne gauche : FMA (haut) + Agenda (bas) */
.left-column{
  display:flex;
  flex-direction:column;
  gap:16px;
  min-height:0;
}

/* Agenda mensuel (bas gauche) */
#agenda-panel.panel{
  padding:0;
  overflow:hidden;
}

#agenda-header{
  padding:14px 16px;
  background:#0d2b52;
  color:#fff;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

#agenda-header span{
  display:flex;
  align-items:center;
  gap:6px;
}

.agenda-nav{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
}

.agenda-nav button{
  border:none;
  border-radius:999px;
  padding:4px 8px;
  background:#b71c1c;
  color:#fff;
  cursor:pointer;
  font-size:14px;
}
.agenda-nav button:hover{
  background:#8b0000;
}

#agenda-body{
  padding:10px 12px 14px;
  background:rgba(255,255,255,0.95);
}

/* Jours de la semaine */
.agenda-weekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  font-size:12px;
  font-weight:600;
  color:#555;
  text-align:center;
  margin-bottom:6px;
}

.agenda-weekdays div{
  padding:4px 0;
}

/* Grille des jours */
.agenda-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  font-size:13px;
}

.agenda-cell{
  height:28px;
  border-radius:8px;
  background:#f5f7fb;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;       /* ‚Üê au lieu de cursor:default */
  user-select:none;
}


.agenda-cell-empty{
  background:transparent;
  cursor:default;
}

/* Aujourd'hui */
.agenda-today{
  background:#0d2b52;
  color:#fff;
  font-weight:700;
}

/* Plus tard : jour avec consigne / √©v√®nement */
.agenda-event{
  background:#ffe0b2;
  color:#5d3d00;
  font-weight:600;
  box-shadow:0 0 0 1px rgba(0,0,0,.05);
}

/* Aujourd'hui + consigne / √©v√®nement */
.agenda-today.agenda-event{
  background:#0d2b52;
  color:#fff;
  font-weight:900;
  outline:2px solid #ff9800;
}
  
  /* D√©tails sous le calendrier */
.agenda-details{
  margin-top:8px;
  padding-top:6px;
  border-top:1px solid #e0e4f0;
  font-size:12px;
}
.agenda-details h4{
  font-size:13px;
  margin-bottom:4px;
  color:#0d2b52;
}
.agenda-details table{
  width:100%;
  border-collapse:collapse;
}
.agenda-details th,
.agenda-details td{
  padding:3px 4px;
  border:1px solid #e3e6f3;
  text-align:left;
}
.agenda-details th{
  background:#f5f7fb;
}
.agenda-details-empty{
  color:#666;
}

  /* ===========================
   üóìÔ∏è Modale agenda (consignes + r√©servations)
   =========================== */
.agenda-modal-section{
  margin-bottom:12px;
}

.agenda-modal-title-sub{
  font-size:14px;
  font-weight:700;
  color:#0d2b52;
  margin-bottom:4px;
  display:flex;
  align-items:center;
  gap:6px;
}

.agenda-consigne-card{
  border-radius:10px;
  border:1px solid #e0e4f0;
  padding:10px 14px;
  margin-top:8px;
  background:#f9fafb;
}

/* ligne : point color√© + titre */
.agenda-consigne-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:700;
  font-size:16px;
  color:#0d2b52;
}

/* point bien visible */
.agenda-consigne-dot{
  width:12px;
  height:12px;
  border-radius:50%;
  flex-shrink:0;
}

/* contenu juste en dessous, align√© √† gauche */
.agenda-consigne-body{
  margin-top:4px;       /* colle le texte sous le titre */
  margin-left:20px;     /* aligne sous le texte du titre, pas sous le point */
  font-size:15px;
  color:#333;
  white-space:pre-wrap;
  text-align:left;
}

/* ligne "Validit√© / Origine / Importance" */
.agenda-consigne-meta{
  margin-top:6px;
  margin-left:20px;
  font-size:13px;
  color:#555;
}

  /* üåü Style propre des consignes dans la modale agenda */
.agenda-consigne-card{
  background:#f8fafc;
  border-radius:10px;
  border:1px solid #e2e8f0;
  padding:10px 12px;
  margin-top:8px;
  text-align:left;          /* tout le texte √† gauche */
}

.agenda-consigne-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:600;
  font-size:15px;
  margin-bottom:4px;        /* petit espace avant le contenu */
}

.agenda-consigne-dot{
  width:10px;
  height:10px;
  border-radius:50%;
  flex-shrink:0;
}

.agenda-consigne-body{
  font-size:14px;
  margin:0;                 /* supprime le ‚Äúsaut‚Äù trop grand */
}

.agenda-consigne-meta{
  margin-top:6px;
  font-size:12px;
  color:#64748b;
}


/* Tableau des r√©servations dans la modale */
.agenda-modal-table-wrapper{
  margin-top:6px;
  overflow:auto;
}

.agenda-modal-table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

.agenda-modal-table th,
.agenda-modal-table td{
  padding:4px 6px;
  border:1px solid #e3e6f3;
  text-align:left;
}

.agenda-modal-table th{
  background:#f5f7fb;
  font-weight:600;
}


/* Les deux panneaux de la colonne gauche prennent chacun ~50% */
.left-column > #formation-panel,
.left-column > #agenda-panel{
  flex:1;
  min-height:0;
}


/* ‚úÖ Main courante (droite) ‚Äì existant */
#journal-panel.panel{ overflow:hidden;padding:0; }
#journal-header{
  padding:14px 16px;background:#0d2b52;color:#fff;font-weight:700;
}
#journal-list{
  padding:12px 14px;
  overflow:auto;max-height:100%;
  display:flex;flex-direction:column;gap:10px;
}
.journal-item{
  display:flex;gap:10px;align-items:flex-start;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 10px;box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.journal-item .icon{font-size:18px;line-height:1.2}
.journal-item .body .title{font-weight:700;color:#0d2b52;margin-bottom:2px}
.journal-item .body .text{color:#333;margin-bottom:4px}
.journal-item .body .date{font-size:12px;color:#666}

footer{text-align:center;color:#fff;font-size:13px;padding:25px;margin-top:auto;}

/* =========================================================
   === Structure/hauteur (inchang√©)
   ========================================================= */
html,body{ height:100dvh; }
body{ min-height:100dvh; display:flex; flex-direction:column; }

main{
  flex:1;
  min-height:0;
  margin:16px auto;
  padding:0 16px;
  gap:16px;
}
.section,.panel{ min-height:0; display:flex; flex-direction:column; }

.section.vehicules{ display:flex; flex-direction:column; }
#vehicule-grid{ flex:1; min-height:0; overflow:auto; }

#journal-panel{ display:flex; flex-direction:column; }
#journal-list{ flex:1; min-height:0; overflow:auto; }

header{ padding:12px 24px; }
nav.menu-bar a{ padding:10px 12px; }

@media (max-height: 820px){
  main{ margin:12px auto; gap:12px; }
  #vehicule-grid{ grid-auto-rows:72px; }
}

/* ================================
   üßæ Overlay "FMA √† saisir"
   ================================ */
.fma-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.45);
  z-index:3000; display:none; align-items:center; justify-content:center; padding:20px;
}
.fma-pending-card{
  background:#fff; border-radius:14px; padding:16px 18px;
  width:95%; max-width:720px; margin:0 auto;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
/* Modale Agenda un peu plus large */
#agenda-modal .fma-pending-card{
  max-width:960px;      /* largeur agrandie */
  padding:20px 24px;    /* un peu plus d'air √† l'int√©rieur */
}

/* Taille de police g√©n√©rale de la modale agenda */
#agenda-modal .fma-pending-card{
  font-size:16px; /* ‚Üë augmente tout le texte de base */
}

/* Sous-titres ("Consignes du jour", "R√©servations v√©hicules") */
#agenda-modal .agenda-modal-title-sub{
  font-size:17px;
}

/* Titre des consignes + point color√© */
#agenda-modal .agenda-consigne-title{
  font-size:16px;
}

/* Texte des consignes */
#agenda-modal .agenda-consigne-body{
  font-size:15px;
}

/* Meta des consignes (validit√©, importance‚Ä¶) */
#agenda-modal .agenda-consigne-meta{
  font-size:13px;
}

/* Tableau des r√©servations */
#agenda-modal .agenda-modal-table th,
#agenda-modal .agenda-modal-table td{
  font-size:15px;
}

  
.fma-pending-card .head{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
}
.fma-pending-card .title{ font-weight:800; color:#0d2b52; display:flex; align-items:center; gap:8px; }
.fma-pending-card .badge{
  display:inline-block; padding:2px 8px; border-radius:999px;
  border:1px solid #a7e2be; background:#e6f7ec; color:#0a8a3a; font-weight:800; font-size:12px;
}
.fma-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.fma-btn{ border:none; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; }
.fma-btn.primary{ background:#0b5bd3; color:#fff; }
.fma-btn.ghost{ background:#eef2ff; color:#223; }
.fma-pending-card .body{ margin-top:10px; max-height:50vh; overflow:auto; }
.fma-pending-card table{ width:100%; border-collapse:collapse; }
.fma-pending-card th, .fma-pending-card td{ border:1px solid #eef2fb; padding:8px 10px; text-align:left; }
.fma-pending-card th{ background:#f7f9ff; color:#123; }

/* ===========================
   üì± ADAPTATION MOBILE (‚â§ 768px)
   =========================== */
@media (max-width: 768px) {

  /* Evite les bugs de 100dvh sur mobile */
  html, body {
    height: auto;
  }
  body {
    min-height: 100vh;
  }

  /* HEADER en colonne + centr√© */
  header {
    flex-direction: column;
    align-items: center;        /* centre le logo horizontalement */
    justify-content: center;
    gap: 8px;
    padding: 10px 14px;
    text-align: center;         /* centre le texte √† l‚Äôint√©rieur du header */
  }

  header img {
    height: 50px;
  }

  header .title-block {
    text-align: center;         /* "Accueil CS..." + "Bienvenue..." centr√©s */
    width: 100%;
  }

  header h1 {
    font-size: 20px;
    margin-top: 2px;
  }

  header p {
    font-size: 13px;
  }
  .logout-btn {
    align-self: stretch;
    width: 100%;
    text-align: center;
    padding: 8px 0;
    font-size: 14px;
    border-radius: 999px;
  }

  /* MENU : barre scrollable, items plus compacts */
  nav.menu-bar {
    overflow-x: auto;
    overflow-y: visible; /* important pour que les sous-menus puissent sortir */
  }
  nav.menu-bar ul {
    flex-wrap: nowrap;
    gap: 8px;
    padding: 6px 8px;
  }
  nav.menu-bar a {
    padding: 8px 10px;
    font-size: 13px;
    white-space: nowrap; /* √©vite les retours bizarres dans les libell√©s */
  }

  /* üîΩ GESTION DES SOUS-MENUS SUR MOBILE üîΩ */

  /* On neutralise le :hover pr√©vu pour le PC */
  nav.menu-bar ul li:hover ul {
    display: none;
  }

  /* Les sous-menus ne sont plus en position absolue,
     ils poussent le contenu vers le bas (mode accord√©on) */
  nav.menu-bar ul li ul {
    position: static;
    margin-top: 4px;
    box-shadow: none;
    border-radius: 8px;
    min-width: 100%;
    font-size: 13px;
    display: none;              /* ferm√©s par d√©faut */
  }

  /* Quand le <li> a la classe .open ‚Üí on ouvre le sous-menu */
  nav.menu-bar ul li.open > ul {
    display: flex;
    flex-direction: column;
  }

  /* On marque visuellement l'item parent ouvert */
  nav.menu-bar ul li.open > a {
    background: #b71c1c;
  }

  nav.menu-bar ul li ul li a {
    font-size: 13px;
    padding: 8px 10px;
    white-space: normal; /* sous-menu peut retourner √† la ligne */
  }

  /* Bandeau m√©t√©o : un peu plus compact */
  .meteo-banner {
    padding: 8px 10px;
  }
  .meteo-row.small {
    font-size: 12px;
  }

  /* MAIN d√©j√† en 1 colonne √† 980px, on all√®ge juste les marges */
  main {
    margin: 12px auto;
    padding: 0 10px;
    gap: 14px;
  }

  .section,
  .panel {
    padding: 16px;
  }

  .section h2 {
    font-size: 18px;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  /* Groupe de boutons dans "√âtat des v√©hicules" : full width */
  .section.vehicules .section-header > div {
    width: 100%;
    justify-content: flex-start;
    flex-wrap: wrap;
  }
  .section.vehicules .section-header .btn,
  .section.vehicules .section-header .print-btn {
    width: 100%;
    text-align: center;
  }

  /* Grille v√©hicules : tu as d√©j√† les colonnes qui se r√©duisent,
     on garde juste un peu de hauteur */
  #vehicule-grid {
    grid-auto-rows: 70px;
  }
  .vehicule-card {
    font-size: 14px;
    padding: 8px 10px;
  }

  /* Listes de journal / formation : texte un peu plus petit */
  .journal-item .body .text {
    font-size: 14px;
  }
  .journal-item .body .date {
    font-size: 11px;
  }

  /* Modales : garantis un peu de marge lat√©rale si tr√®s petit √©cran */
  #anom-modal > div,
  #myfma-modal > div,
  .fma-pending-card {
    width: 100%;
    max-width: 100%;
  }

  /* üìò & üìù Limiter la hauteur et activer le scroll interne sur mobile */
  #formation-panel,
  #journal-panel {
    max-height: none;
  }

  #formation-list,
  #journal-list {
    max-height: 40vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
}

</style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/LsB40JQq/logo-cismic.png" alt="Logo SDIS 30">
  <div class="title-block">
    <h1 id="cis-title">Centre de Secours</h1>
    <p id="welcome-text">Bienvenue</p>
  </div>
  <button class="logout-btn" onclick="logout()">Se d√©connecter</button>
</header>

<!-- ‚úÖ MENU PRINCIPAL -->
<nav class="menu-bar">
  <ul>
    <li id="menu-agent"><a href="#">Agent du centre</a>
      <ul>
        <li><a href="#" onclick="return openLink('Mes infos.html', event)">Mes infos</a></li>
        <li><a href="#" onclick="return openMyFma(event)">Consulter ma FMA</a></li>
       <li><a href="#" onclick="return openLink('messagerie.html', event)">Messagerie interne</a></li>
        <li>
  <a href="#"
     onclick="return composeOutlook(
       'LOG-SAPSP-CHU@sdis30.fr',
       'Mat√©riel laiss√© au CH',
       'Bonjour,\n\nVeuillez trouver les informations du mat√©riel laiss√© au CH\n\n* Date : \n* Heure : \n* N¬∞ Intervention : \n* Nom du mat√©riel : \n\nBonne journ√©e.',
       event
     )">
    Mat√©riel laiss√© CHU
  </a>
</li>

        <li><a href="#" onclick="return openLink('reservations_vehicules.html', event)">R√©servation v√©hicule</a></li>
        <li><a href="#" onclick="return openLink('https://gipsis.sdis30.fr/index.php?page=menu_personnels', event)">GIPSIS</a></li>
        <li><a href="#" onclick="return openLink('http://autocsweb/autocs7/', event)">AUTO-CS Web</a></li>
        <li><a href="#" onclick="return openLink('https://www.plateforme-apis.fr/login/index.php', event)">APIS</a></li>
        <li><a href="#" onclick="return openLink('http://intranet/Pages/System/default.aspx', event)">Intranet</a></li>
      </ul>
    </li>

    <li id="menu-sog"><a href="#">SOG</a>
      <ul>
        <li><a href="#" onclick="return openLink('https://drive.google.com/drive/folders/1BapXSZxU9dP-UL4piwDnsLoCL0JoTamw?usp=sharing', event)">Proc√©dures SOG</a></li>
        <li><a href="#" onclick="return openLink('consignes.html', event)">Consignes</a></li>
        <li><a href="#" onclick="return openLink('fma.html', event)">FMA</a></li>
        <li><a href="#" onclick="return openLink('Manoeuvre de repli.html', event)">Manoeuvre de repli</a></li>
        <li><a href="#" onclick="return openLink('https://fastsms.novadial.fr/', event)">SMS NOVADIAL</a></li>
        <li><a href="#" onclick="return openLink('http://outlook.com/owa/sdis30.fr/ver-ops@sdisgard.mail.onmicrosoft.com', event)">Messagerie Outlook</a></li>
        <li><a href="#" onclick="return openLink('http://10.0.32.31/php-bin/WebClient.php?lang=fr', event)">Annuaire SDIS30</a></li>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1kORIFDJmEuRhvn3WSSiTCqLg_qF4wk5g/view?usp=sharing', event)">ICP</a></li>
      </ul>
    </li>

    <li id="menu-formation"><a href="#">Formation</a>
      <ul>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1baVsjzbGfXOByg2vtoAsQaOlPGuCYXZk/view?usp=sharing', event)">Calendrier stages 2026</a></li>
       <li><a href="#" onclick="return openLink('demande_stage.html', event)">Demande de stages</a></li>
      </ul>
    </li>

    <li id="menu-fdf"><a href="#">FDF</a>
      <ul>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1QDOb394zuuG1zNUJLsax1XHoaIZ_ZbFh/view?usp=sharing', event)">Ordre op√©ration FDF 2025</a></li>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/13H5arwISXkMypijs8DNTvqyZd0JBTS2F/view?usp=sharing', event)">Prise en compte CCF FDF2</a></li>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1rIaBifgvCf6F1HZzqLabL21FLQa3Mr4s/view?usp=sharing', event)">Prise en compte GIFF FDF3</a></li>
      </ul>
    </li>

    <li id="menu-pharma"><a href="#">Pharmacie</a>
      <ul>
        <li><a href="#" onclick="return openLink('commande pharmacie.html', event)">Commande pharmacie</a></li>
        <li><a href="#" onclick="return composeOutlook('SSSM-PHARMACIE@sdis30.fr', event)">Contact</a></li>
      </ul>
    </li>

    <li id="menu-habillement"><a href="#">Habillement</a>
      <ul>
        <li><a href="#" onclick="return openLink('gestion_habillement.html', event)">Envoyer un article</a></li>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1lKSSE6LJf12PG8Nt7uX_6zR03qXDHvHz/view?usp=sharing', event)">Compte-rendu de perte</a></li>
        <li><a href="#" onclick="return openLink('https://drive.google.com/file/d/1OIAaYX3NBvQeNTNkBlVoXSGCxCyC2NBU/view?usp=sharing', event)">Compte-rendu de vol</a></li>
      </ul>
    </li>

    <li id="menu-mnr"><a href="#">MNR</a>
      <ul>
        <li><a href="#" onclick="return openLink('mnr-envoyer.html', event)">Envoyer un article</a></li>
        <li><a href="#" onclick="return composeOutlook('GFST-MNR@sdis30.fr', event)">Contact</a></li>
      </ul>
    </li>

    <li id="menu-v√©hicules"><a href="#">V√©hicules</a>
      <ul>
        <li><a href="#" onclick="return openLink('suivi_vehicules.html', event)">Suivi parc v√©hicules</a></li>
      </ul>
    </li>

    <li id="menu-patrimoine"><a href="#">Patrimoine</a>
      <ul>
        <li><a href="#" onclick="return openLink('patrimoine.html', event)">Signaler un d√©faut</a></li>
        <li><a href="#" onclick="return openLink('http://symphonieboxprod', event)">As-Tech</a></li>
      </ul>
    </li>

    <li id="menu-magasin"><a href="#">Magasin</a>
      <ul>
        <li><a href="#" onclick="return composeOutlook('GFST-MAGASIN@sdis30.fr', event)">Contact</a></li>
      </ul>
    </li>

    <li id="menu-admin"><a href="#">Administrateur</a>
      <ul>
        <li><a href="#" onclick="return openLink('admin.html', event)">Gestion des acc√®s</a></li>
<li><a id="btnPurgeNotes" href="#" onclick="return purgeJournal('notes', event)">üßπ Vider les mains courantes</a></li>
<li><a id="btnPurgeAll" href="#" onclick="return purgeJournal('all', event)">üóëÔ∏è Purge compl√®te du site</a></li>

      </ul>
    </li>
  </ul>
</nav>

<!-- üå§Ô∏è Bandeau m√©t√©o fin (centr√©) -->
<div class="meteo-banner" aria-label="Bandeau m√©t√©o Verg√®ze">
  <div class="meteo-row">
    <span class="emoji" id="meteo-emoji">‚Äî</span>
    <span class="temp"  id="meteo-temp">--¬∞C</span>
    <span class="desc"  id="meteo-desc">‚Äî</span>
  </div>
  <div class="meteo-row small">
    <span>Lever&nbsp;: <strong id="meteo-sunrise">--:--</strong></span>
    <span>Coucher&nbsp;: <strong id="meteo-sunset">--:--</strong></span>
    <span>Rafales&nbsp;: <strong id="meteo-gust">-- km/h</strong></span>
    <span>Humidit√©&nbsp;: <strong id="meteo-humidity">--%</strong></span>
  </div>
</div>

<main>

   <!-- Colonne gauche : üìå Main courante FMA (haut) + üìÖ Agenda mensuel (bas) -->
  <div class="left-column">

   <!-- üìå Consignes du jour (haut) -->
<div id="formation-panel" class="panel">
  <div id="formation-header">
    <span>üìå Consignes</span>
    <button
      type="button"
      id="consignes-plus-btn"
      class="header-plus-btn"
      style="display:none;"
      onclick="return openLink('consignes.html', event)"
    >
      +
    </button>
  </div>
  <div id="formation-list"></div>
</div>



    <!-- üìÖ Agenda mensuel (bas) -->
    <div id="agenda-panel" class="panel">
      <div id="agenda-header">
        <span>üìÖ Agenda du centre</span>
        <div class="agenda-nav">
          <button id="agenda-prev" type="button">‚óÄ</button>
          <span id="agenda-month-label"></span>
          <button id="agenda-next" type="button">‚ñ∂</button>
        </div>
      </div>
      <div id="agenda-body">
        <div class="agenda-weekdays">
          <div>Lun</div>
          <div>Mar</div>
          <div>Mer</div>
          <div>Jeu</div>
          <div>Ven</div>
          <div>Sam</div>
          <div>Dim</div>
        </div>
        <div id="agenda-grid" class="agenda-grid"></div>
        <div id="agenda-details" class="agenda-details"></div>

      </div>
    </div>

  </div>


  <!-- üöí √âTAT DES V√âHICULES (colonne centre) -->
  <div class="section vehicules">
    <div class="section-header">
      <h2>üöí √âtat des v√©hicules</h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <button id="btn-print-anom" class="print-btn" onclick="printAnomalies()">üñ®Ô∏è Imprimer anomalies</button>
        <button id="btn-signal-anom" class="btn" onclick="openLink('vehicules.html')">Signaler une anomalie</button>
      </div>
    </div>
    <div id="vehicule-grid"></div>
  </div>

    <!-- üè≠ MATERIEL EN ANOMALIE -->
  <div class="section vehicules" id="materiel-section" style="display:none;margin-top:-10px;">
    <div class="section-header">
      <h2>üè≠ √âtat mat√©riels</h2>
    </div>
    <div id="materiel-grid"></div>
  </div>


  <!-- üìù Main courante op√©rationnelle (colonne droite) -->
  <div id="journal-panel" class="panel">
    <div id="journal-header">üìù Main courante op√©rationnelle</div>
    <div id="journal-list"></div>
  </div>

</main>

<!-- üßæ OVERLAY : FMA √† saisir -->
<div id="fmaOverlay" class="fma-overlay" style="display:none">
  <div id="fmaPendingCard" class="fma-pending-card">
    <div class="head">
      <div class="title">üìò FMA √† saisir <span class="badge" id="fmaPendingCount"></span></div>
      <div class="fma-actions">
        <button id="fmaGoBtn" class="fma-btn primary">Aller √† la page FMA</button>
        <button id="fmaDismissBtn" class="fma-btn ghost">OK</button>
      </div>
    </div>
    <div class="body">
      <table>
        <thead><tr><th>Date</th><th>Th√®me</th><th>Formateur</th></tr></thead>
        <tbody id="fmaPendingBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- üõéÔ∏è OVERLAY : Nouvelles demandes de r√©servation v√©hicule -->
<div id="resOverlay" class="fma-overlay" style="display:none">
  <div id="resPendingCard" class="fma-pending-card">
    <div class="head">
      <div class="title">üöò Nouvelles demandes de r√©servation <span class="badge" id="resPendingCount"></span></div>
      <div class="fma-actions">
        <button id="resGoBtn" class="fma-btn primary">Aller √† la page R√©servations</button>
        <button id="resDismissBtn" class="fma-btn ghost">OK</button>
      </div>
    </div>
    <div class="body">
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Heures</th><th>Agent</th><th>Motif</th><th>Destination</th>
          </tr>
        </thead>
        <tbody id="resPendingBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- üß∫ OVERLAY : Nouveaux d√©p√¥ts habillement (AJOUT MINIMAL) -->
<div id="habOverlay" class="fma-overlay" style="display:none">
  <div id="habPendingCard" class="fma-pending-card">
    <div class="head">
      <div class="title">üß∫ Nouveaux d√©p√¥ts habillement <span class="badge" id="habPendingCount"></span></div>
      <div class="fma-actions">
        <button id="habGoBtn" class="fma-btn primary">Aller √† Habillement</button>
        <button id="habSeenBtn" class="fma-btn ghost">Marquer comme lu</button>
      </div>
    </div>
    <div class="body">
      <table>
        <thead>
          <tr><th>Date</th><th>Agent</th><th>Matricule</th><th>Effets</th></tr>
        </thead>
        <tbody id="habPendingBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- üì® OVERLAY : Nouveaux messages -->
<div id="mailOverlay" class="fma-overlay" style="display:none">
  <div id="mailPendingCard" class="fma-pending-card">
    <div class="head">
      <div class="title">üì¨ Nouveaux messages <span class="badge" id="mailPendingCount"></span></div>
      <div class="fma-actions">
        <button id="mailGoBtn" class="fma-btn primary">Ouvrir la messagerie</button>
        <button id="mailMarkReadBtn" class="fma-btn ghost">Marquer comme lus</button>
      </div>
    </div>
    <div class="body">
      <table>
        <thead>
          <tr><th>Date</th><th>De</th><th>Objet</th></tr>
        </thead>
        <tbody id="mailPendingBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- üóìÔ∏è MODALE : D√©tails agenda (consignes + r√©servations) -->
<div id="agenda-modal" class="fma-overlay" style="display:none">
  <div class="fma-pending-card">
    <div class="head">
      <div class="title" id="agenda-modal-title">üìÖ D√©tails du jour</div>
      <div class="fma-actions">
        <button id="agenda-modal-close" class="fma-btn ghost">Fermer</button>
      </div>
    </div>
    <div class="body">
      <!-- Tout le contenu (consignes + r√©servations) sera inject√© ici -->
      <div id="agenda-modal-body"></div>
    </div>
  </div>
</div>




<!-- FIN AJOUT -->

<footer>¬© 2025 CISMIC ‚Äì Tous droits r√©serv√©s</footer>

<!-- üîå Firebase + Firestore + stockage partag√© -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="cloud-storage.js"></script>





<script>
    // Premier affichage
  renderAgenda();
function openLink(url, evt){
  if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
  try{
    const u = new URL(url, window.location.href);
    const isHtml = /\.html?(\?|#|$)/i.test(u.pathname);
    if (isHtml){ window.location.href = u.href; }
    else { window.open(u.href, '_blank', 'noopener,noreferrer'); }
  }catch(e){
    window.open(url, '_blank', 'noopener,noreferrer');
  }
  return false;
}
function composeOutlook(to,subject,body, evt){
  if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
  const link=`https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject||"")}&body=${encodeURIComponent(body||"")}`;
  window.open(link,'_blank','noopener,noreferrer');
  return false;
}
function logout(){localStorage.removeItem("csver_session");alert("D√©connexion r√©ussie.");window.location.href="login.html";}

function getEtatColor(e){
  return({"Disponible":"#4caf50","Mineur":"#ff9800","Atelier":"#2196f3","Pret":"#9c27b0","Indispo":"#f44336"}[e]||"#5f6368");
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => (
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
  ));
}
function normCis(x){
  try{
    return String(x||"").replace(/^CIS\s*/i,"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();
  }catch(_){ return String(x||"").toLowerCase(); }
}

/* ‚úÖ Ajout : r√©cup√©rer les permissions applicables au CIS courant */
function getCurrentCisPerms(){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return {};
    const fiche   = JSON.parse(localStorage.getItem("csver_user_"+session.matricule) || "null");
    if(!fiche || !fiche.permissions) return {};
    const cisCur  = Array.isArray(session.cis) ? session.cis[0] : session.cis;

    const same = (a,b)=> normCis(a) === normCis(b);

    const cisPrimary = fiche.cis && fiche.cis.primary ? fiche.cis.primary : null;
    const isPrimary  = cisPrimary && same(cisPrimary, cisCur);

    if(isPrimary){
      return fiche.permissions.primary || {};
    }else{
      const sec = fiche.permissions.secondaries || {};
      const k = sec[cisCur] ? cisCur : (Object.keys(sec).find(x=>same(x,cisCur)) || null);
      return (k ? sec[k] : {}) || {};
    }
  }catch(_){ return {}; }
}

/* ‚úÖ Affichage s√©lectif des menus + boutons selon les permissions du CIS courant */
function applyRoleMenus(roleRaw){
  const ids = [
    "menu-agent","menu-sog","menu-formation","menu-fdf","menu-pharma",
    "menu-habillement","menu-mnr","menu-atelier","menu-magasin",
    "menu-v√©hicules",           // üëà ajout pour pouvoir le masquer/afficher
    "menu-admin"
  ];
  const hideAll = () => ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display="none";
  });

  const session = JSON.parse(localStorage.getItem("csver_session")||"null");
  const fiche   = session ? JSON.parse(localStorage.getItem("csver_user_"+session.matricule) || "null") : null;
  const cisCur  = Array.isArray(session?.cis) ? session.cis[0] : session?.cis;

  // R√©cup√®re le bloc de permissions pertinent (principal vs secondaire)
  let perms = null;
  if(fiche && fiche.permissions){
    const cisPrimary = fiche.cis && fiche.cis.primary ? fiche.cis.primary : null;
    const isPrimary  = cisPrimary && normCis(cisPrimary) === normCis(cisCur);
    if(isPrimary){
      perms = fiche.permissions.primary || null;
    }else{
      const sec = fiche.permissions.secondaries || {};
      perms = sec[cisCur] || sec[Object.keys(sec).find(k => normCis(k)===normCis(cisCur))] || null;
    }
  }

  const btnPrint  = document.getElementById("btn-print-anom");
  const btnSignal = document.getElementById("btn-signal-anom");
  // üëá On laisse EXACTEMENT la logique actuelle des boutons : SOG OU Admin
  const showVehBtns = (v)=>{
    if(btnPrint)  btnPrint.style.display  = v ? "" : "none";
    if(btnSignal) btnSignal.style.display = v ? "" : "none";
  };

  if(perms && Object.keys(perms).length>0){
    hideAll();

    // Cas "agent seul" inchang√©
    const onlyAgent = !!perms.agent &&
      !perms.sog && !perms.admin &&
      !perms.formation && !perms.fdf && !perms.pharma &&
      !perms.habillement && !perms.mnr && !perms.atelier && !perms.magasin && !perms["v√©hicules"];
    if(onlyAgent){
      ["menu-agent","menu-formation","menu-fdf","menu-habillement"].forEach(id=>{
        const el=document.getElementById(id); if(el) el.style.display="";
      });
      showVehBtns(false);
      return;
    }

    // Raccourci SOG (comme avant) MAIS ‚ÄúV√©hicules‚Äù d√©pend d‚Äôune case d√©di√©e
    if(perms.sog){
      ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
      const adminEl = document.getElementById("menu-admin"); if(adminEl) adminEl.style.display = perms.admin ? "" : "none";
      // üëá Masquer ‚ÄúV√©hicules‚Äù si la case n‚Äôest pas coch√©e et pas admin
      if(!perms["v√©hicules"] && !perms.admin){
        const m = document.getElementById("menu-v√©hicules");
        if(m) m.style.display = "none";
      }
      // ‚úÖ Boutons : SOG ou Admin (inchang√©)
      showVehBtns(!!perms.sog || !!perms.admin);
      return;
    }

    // Affichage fin par fin (on traite "v√©hicules" √† part)
    const map = {
      agent:"menu-agent", sog:"menu-sog", formation:"menu-formation", fdf:"menu-fdf",
      pharma:"menu-pharma", habillement:"menu-habillement", mnr:"menu-mnr",
      atelier:"menu-atelier", magasin:"menu-magasin", admin:"menu-admin",
      "v√©hicules":"menu-v√©hicules"   // üëà mapping pour ‚ÄúV√©hicules‚Äù
    };
    Object.keys(map).forEach(k=>{
      const el = document.getElementById(map[k]);
      if(!el) return;
      if(k === "v√©hicules"){
        // üëá Le menu n‚Äôappara√Æt que si case ‚Äúv√©hicules‚Äù ou admin
        el.style.display = (perms["v√©hicules"] || perms.admin) ? "" : "none";
      }else{
        el.style.display = perms[k] ? "" : "none";
      }
    });

    // ‚úÖ Boutons : SOG ou Admin (inchang√©)
    showVehBtns(!!perms.sog || !!perms.admin);
    return;
  }

  /* Fallback r√¥les anciens ‚Äî inchang√© */
  const role = String(roleRaw||"").toLowerCase();
  hideAll();
  if(role === "agent"){
    ["menu-agent","menu-formation","menu-habillement"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
  }else if(role === "sog spv"){
    ["menu-agent","menu-sog","menu-formation","menu-habillement","menu-mnr"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
  }else if(role === "spp"){
    ["menu-agent","menu-sog","menu-formation","menu-fdf","menu-pharma","menu-habillement","menu-mnr"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
  }else if(role === "admin" || role === "commandement"){
    ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
  }else{
    ["menu-agent","menu-formation","menu-habillement"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display=""; });
  }

  // ‚úÖ Boutons fallback : SOG/SPP/Admin/Commandement (inchang√©)
  const showVehBtnsFallback = (role === "sog spv" || role === "spp" || role === "admin" || role === "commandement");
  showVehBtns(showVehBtnsFallback);
}

function updateConsignesPlusVisibility(){
  try{
    const btn = document.getElementById("consignes-plus-btn");
    if(!btn) return;

    // 1Ô∏è‚É£ On essaie d'abord avec le syst√®me de permissions par CIS
    const perms = getCurrentCisPerms ? getCurrentCisPerms() : {};
    if(perms && Object.keys(perms).length > 0){
      // visible pour SOG ou ADMIN dans les permissions du centre
      const show = !!perms.sog || !!perms.admin;
      btn.style.display = show ? "flex" : "none";
      return;
    }

    // 2Ô∏è‚É£ Fallback : ancien syst√®me bas√© sur session.role
    const session = JSON.parse(localStorage.getItem("csver_session") || "null");
    if(!session){
      btn.style.display = "none";
      return;
    }

    const role = String(session.role || "").toLowerCase();

    // ici tu peux ajuster qui voit le bouton
    const showFallback = (role === "sog" || role === "sog spv" || role === "admin");
    btn.style.display = showFallback ? "flex" : "none";

  }catch(e){
    console.error("Erreur visibilit√© bouton consignes :", e);
  }
}


  
/* Chargement initial */
let cis="",key="";
window.addEventListener("DOMContentLoaded", async ()=>{
  // üîÅ On commence par synchroniser avec Firestore
  try{
    await syncAccueilFromCloud();
  }catch(e){
    console.error("Erreur de synchro cloud au chargement :", e);
  }

  const user=JSON.parse(localStorage.getItem("csver_session")||"null");
  if(!user){alert("Session expir√©e.");window.location.href="login.html";return;}
  cis=Array.isArray(user.cis)?user.cis[0]:user.cis;
  key="vehicules_"+cis;

  const nomComplet=((user.prenom||"")+" "+(user.nom||"")).trim()||user.matricule;
  document.getElementById("cis-title").textContent=`CISMIC ${cis}`;
  document.getElementById("welcome-text").textContent=`Bienvenue ${nomComplet}`;

  applyRoleMenus(user.role);
  updateConsignesPlusVisibility();   // üëâ affiche le + pour SOG / ADMIN
// üîê Masquer les actions de purge pour tous sauf super-admin 1414 OU admin du centre
if (!isSuperAdmin() && !isAdmin()) {
    const btn1 = document.getElementById("btnPurgeNotes");
    const btn2 = document.getElementById("btnPurgeAll");

    if (btn1) btn1.style.display = "none";
    if (btn2) btn2.style.display = "none";
}


  renderVehicules(JSON.parse(localStorage.getItem(key)||"[]"));
  renderJournal();
  renderFormations();       // üìò panneau gauche
  fetchMeteoVergeze();      // üå§Ô∏è bandeau
  setInterval(fetchMeteoVergeze, 30*60*1000); // toutes les 30 min

  // üëâ Overlay FMA au chargement
  renderFmaPendingCard();
});

window.addEventListener("focus",()=>{
  const vehicules=JSON.parse(localStorage.getItem(key)||"[]");
  renderVehicules(vehicules);
  renderJournal();
  renderFormations();
  fetchMeteoVergeze();
  // üëâ R√©√©value √† l‚Äôarriv√©e sur l‚Äôonglet
  renderFmaPendingCard();
});
window.addEventListener("pageshow",()=>{
  const vehicules=JSON.parse(localStorage.getItem(key)||"[]");
  renderVehicules(vehicules);
  renderJournal();
  renderFormations();
  // üëâ R√©√©value sur pageshow (Firefox/Back-Forward cache)
  renderFmaPendingCard();
});
document.addEventListener("visibilitychange",()=>{
  if(!document.hidden){
    const vehicules=JSON.parse(localStorage.getItem(key)||"[]");
    renderVehicules(vehicules);
    renderJournal();
    renderFormations();
    renderFmaPendingCard();
  }
});
window.addEventListener("storage",(e)=>{
  try{
    if(!e.key) return;
    const user=JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!user) return;
    const cisSel = Array.isArray(user.cis)?user.cis[0]:user.cis;
    if(e.key===key || e.key==="journal_"+cisSel || e.key==="fma_data_v2" || e.key===("anomalies_"+cisSel)){
      renderMateriel(buildMaterielEtatList(cisSel));
      renderVehicules(JSON.parse(localStorage.getItem(key)||"[]"));
      renderJournal();
      renderFormations();
      renderFmaPendingCard();
    }
  }catch(_){}
});

/* üå§Ô∏è Open-Meteo pour Verg√®ze (~43.74, 4.20) ‚Äî Bandeau centr√© */
async function fetchMeteoVergeze(){
  const lat = 43.74, lon = 4.20, tz = "Europe/Paris";
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
    + `&current_weather=true`
    + `&hourly=relative_humidity_2m,wind_gusts_10m,uv_index,precipitation_probability`
    + `&daily=sunrise,sunset`
    + `&timezone=${encodeURIComponent(tz)}`;

  const els = {
    emoji: document.getElementById("meteo-emoji"),
    temp: document.getElementById("meteo-temp"),
    desc: document.getElementById("meteo-desc"),
    sunrise: document.getElementById("meteo-sunrise"),
    sunset: document.getElementById("meteo-sunset"),
    gust: document.getElementById("meteo-gust"),
    humidity: document.getElementById("meteo-humidity"),
  };

  function codeToEmoji(code){
    if([0].includes(code)) return "‚òÄÔ∏è";
    if([1,2].includes(code)) return "üå§Ô∏è";
    if([3].includes(code)) return "‚òÅÔ∏è";
    if([45,48].includes(code)) return "üå´Ô∏è";
    if([51,53,55].includes(code)) return "üå¶Ô∏è";
    if([56,57,61,63,65,66,67,80,81,82].includes(code)) return "üåßÔ∏è";
    if([71,73,75,77,85,86].includes(code)) return "üå®Ô∏è";
    if([95,96,99].includes(code)) return "‚õàÔ∏è";
    return "üå°Ô∏è";
  }
  function codeToText(code){
    const m = {
      0:"Ciel clair",1:"Plut√¥t clair",2:"Partiellement nuageux",3:"Couvert",
      45:"Brouillard",48:"Brouillard givrant",
      51:"Bruine faible",53:"Bruine",55:"Bruine forte",
      56:"Bruine vergla√ßante",57:"Bruine vergla√ßante forte",
      61:"Pluie faible",63:"Pluie",65:"Pluie forte",
      66:"Pluie vergla√ßante",67:"Pluie vergla√ßante forte",
      71:"Neige faible",73:"Neige",75:"Neige forte",77:"Grains de neige",
      80:"Averses faibles",81:"Averses",82:"Averses fortes",
      85:"Averses de neige",86:"Averses de neige fortes",
      95:"Orage",96:"Orage avec gr√™le",99:"Orage fort avec gr√™le"
    };
    return m[code] || "Conditions";
  }
  const fmtTime = s => { try{ return s.split("T")[1].slice(0,5); }catch{ return "--:--"; } };

  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();

    const cw = data.current_weather || {};
    const hourly = data.hourly || {};
    const daily = data.daily || {};

    // Index de l‚Äôheure courante pour r√©cup√©rer humidit√©/rafales
    let idxNow = -1;
    if (hourly.time && cw.time){
      idxNow = hourly.time.indexOf(cw.time);
    }

    // Emoji / temp / texte
    if(els.emoji) els.emoji.textContent = codeToEmoji(cw.weathercode);
    if(els.temp)  els.temp.textContent  = (cw.temperature!=null? Math.round(cw.temperature)+"¬∞C" : "--¬∞C");
    if(els.desc)  els.desc.textContent  = codeToText(cw.weathercode);

    // √âph√©m√©ride
    if(daily.sunrise && daily.sunset){
      if(els.sunrise) els.sunrise.textContent = fmtTime(daily.sunrise[0]);
      if(els.sunset)  els.sunset.textContent  = fmtTime(daily.sunset[0]);
    }else{
      if(els.sunrise) els.sunrise.textContent = "--:--";
      if(els.sunset)  els.sunset.textContent  = "--:--";
    }

    // Rafales / Humidit√© (valeurs de l‚Äôheure actuelle si dispo)
    let gust = null, hum = null;
    if(idxNow >= 0){
      if(hourly.wind_gusts_10m)      gust = hourly.wind_gusts_10m[idxNow];
      if(hourly.relative_humidity_2m) hum  = hourly.relative_humidity_2m[idxNow];
    }
    if(els.gust)     els.gust.textContent     = (gust!=null ? Math.round(gust)+" km/h" : "-- km/h");
    if(els.humidity) els.humidity.textContent = (hum!=null ? Math.round(hum)+"%" : "--%");

  }catch(e){
    if(els.desc) els.desc.textContent = "M√©t√©o indisponible.";
    if(els.sunrise) els.sunrise.textContent = "--:--";
    if(els.sunset)  els.sunset.textContent  = "--:--";
    if(els.gust) els.gust.textContent = "-- km/h";
    if(els.humidity) els.humidity.textContent = "--%";
  }
}

/* Rendu v√©hicules */
function renderVehicules(vehicules){
  const grid=document.getElementById("vehicule-grid");
  if(!grid) return;
  grid.innerHTML="";

  // ‚úÖ Mat√©riel (anomalies patrimoine non cl√¥tur√©es) ‚Äî affich√© dans le m√™me tableau central
  let mats = [];
  try{
    const session = JSON.parse(localStorage.getItem("csver_session") || "null");
    const cisSel = session ? (Array.isArray(session.cis)?session.cis[0]:session.cis) : "";
    if(cisSel) mats = buildMaterielEtatList(cisSel);
  }catch(_){ mats = []; }

  const vehs = Array.isArray(vehicules) ? vehicules : [];

  if(vehs.length===0 && (!Array.isArray(mats) || mats.length===0)){
    grid.innerHTML="<p style='color:#666;text-align:center;'>Aucun v√©hicule enregistr√©.</p>";
    return;
  }

  // üöí V√©hicules
  vehs.forEach(v=>{
    const div=document.createElement("div");
    div.className="vehicule-card";
    div.style.background=getEtatColor(v.etat||"Disponible");
    let etatAffiche = escapeHtml(v.etat||"Disponible");
    if(v.etat === "Pret" && v.pretNom){ etatAffiche += ` ‚Äî <i>${escapeHtml(v.pretNom)}</i>`; }
    div.innerHTML = `${escapeHtml(v.nom)}<small>${etatAffiche}</small>`;
    div.addEventListener('click', ()=>openVehiculeAnomalies(v.nom));
    grid.appendChild(div);
  });

  // üè≠ Mat√©riels
  if(Array.isArray(mats) && mats.length>0){
    // üëâ Titre (non cliquable) comme pour "√âtat des v√©hicules"
    const title = document.createElement("div");
    title.style.gridColumn = "1 / -1";
    title.style.display = "flex";
    title.style.alignItems = "baseline";
    title.style.gap = "8px";
    title.style.margin = "4px 0 -18px";
    title.style.fontWeight = "800";
    title.style.color = "#0d2b52";
    title.style.fontSize = "20px";
    title.innerHTML = `üè≠ √âtat mat√©riels <span style="font-weight:600;color:#555;font-size:13px;">(${mats.length} anomalie(s) en cours)</span>`;
    grid.appendChild(title);

mats.forEach(m=>{
      const div = document.createElement("div");
      div.className = "vehicule-card";
      div.style.background = getEtatColor(m.etat || "Mineur");
      const etatAff = escapeHtml(m.etat || "Mineur");
      div.innerHTML = `üè≠ ${escapeHtml(m.nom)}<small>${etatAff}</small>`;
      div.addEventListener("click", ()=>openVehiculeAnomalies(m.nom, "patrimoine"));
      grid.appendChild(div);
    });
  }
}



function buildMaterielEtatList(cisSel){
  // √Ä partir des anomalies Patrimoine (page "Anomalies mat√©riel")
  const keyAnom = "anomalies_" + cisSel;
  let arr = [];
  try{ arr = JSON.parse(localStorage.getItem(keyAnom) || "[]"); }catch(_){ arr = []; }
  if(!Array.isArray(arr)) arr = [];

  // On affiche uniquement les anomalies NON cl√¥tur√©es
  const open = arr.filter(a => a && a.cis === cisSel && a.cloturee !== "oui");

  // On √©vite les doublons de nom (si plusieurs entr√©es identiques)
  const seen = new Set();
  const list = [];
  open.forEach(a=>{
    const nom = String(a.equipement || "").trim();
    if(!nom) return;
    const k = nom.toLowerCase();
    if(seen.has(k)) return;
    seen.add(k);

    list.push({
      nom,
      // Couleur du badge : urgent = rouge, sinon orange
      etat: a.urgent ? "Indispo" : "Mineur"
    });
  });

  // Tri alphab√©tique
  list.sort((x,y)=>String(x.nom).localeCompare(String(y.nom), "fr", {sensitivity:"base"}));
  return list;
}


function renderMateriel(list){
  // (d√©sormais affich√© dans le tableau central via renderVehicules)
  const section = document.getElementById("materiel-section");
  if(section) section.style.display = "none";
}

  
/* Impression des anomalies */
function printAnomalies(){
  const session = JSON.parse(localStorage.getItem("csver_session") || "null");
  if(!session){ alert("Session expir√©e."); return; }

  // Nom complet (fallback agents_data)
  let nomComplet = ((session.prenom || "") + " " + (session.nom || "")).trim();
  if(!nomComplet){
    const agents = JSON.parse(localStorage.getItem("agents_data") || "[]");
    const a = agents.find(x => x && x.matricule === session.matricule);
    if(a) nomComplet = ((a.prenom || "") + " " + (a.nom || "")).trim();
  }

  const cis = Array.isArray(session.cis) ? session.cis[0] : session.cis;

  // ‚úÖ CONSIGNES = EXACTEMENT ce qui est affich√©
  const formationListEl = document.getElementById("formation-list");
  const consignesHtml = formationListEl ? formationListEl.innerHTML : "<div class='hint'>Aucune consigne affich√©e.</div>";

  // ‚úÖ Donn√©es anomalies
  const vehs = JSON.parse(localStorage.getItem("vehicules_"+cis) || "[]");
  const mats = JSON.parse(localStorage.getItem("materiel_"+cis)  || "[]");
  const patr = JSON.parse(localStorage.getItem("anomalies_"+cis) || "[]"); // optionnel

  const anomaliesVeh = [];
  const anomaliesMat = [];

  // üöí V√©hicules : history ouverte
  (Array.isArray(vehs) ? vehs : []).forEach(v=>{
    (v.history || []).filter(h=>!h.closed).forEach(h=>{
      let agentAffiche = (h.agent || "").trim();
      if(/^[0-9]+$/.test(agentAffiche) || agentAffiche === "") agentAffiche = nomComplet || "-";

      let etatAffiche = (h.level || "");
      if(v.pretNom && v.etat === "Pret") etatAffiche += " ‚Äî " + v.pretNom;

      anomaliesVeh.push({
        support: v.nom || "-",
        etat: etatAffiche || "-",
        desc: h.text || "-",
        agent: agentAffiche
      });
    });
  });

  // üè≠ Mat√©riel : history ouverte
  (Array.isArray(mats) ? mats : []).forEach(m=>{
    (m.history || []).filter(h=>!h.closed).forEach(h=>{
      let agentAffiche = (h.agent || "").trim();
      if(/^[0-9]+$/.test(agentAffiche) || agentAffiche === "") agentAffiche = nomComplet || "-";

      anomaliesMat.push({
        support: m.nom || "-",
        etat: (h.level || "-"),
        desc: (h.text || "-"),
        agent: agentAffiche,
        source: "Mat√©riel"
      });
    });
  });

  // üè≠ Patrimoine : non cl√¥tur√©es (si pr√©sent)
  const mapCat = {
    menuiserie:"Menuiserie",
    chauffage_clim:"Chauffage clim",
    ecs:"Eau chaude sanitaire",
    ecoulement_bouches:"√âcoulement bouches",
    electricite:"√âlectricit√©",
    fuite_eau:"Fuite d'eau",
    nuisibles:"Nuisibles",
    portail:"Portail",
    securite_incendie:"S√©curit√© incendie",
    station_carburant:"Station carburant",
    electromenager:"√âlectrom√©nager",
    informatique:"Informatique",
    groupe_electrogene:"Groupe √©lectrog√®ne",
    autre_demande:"Autre demande"
  };

  (Array.isArray(patr) ? patr : [])
    .filter(a => a && a.cis === cis && a.cloturee !== "oui")
    .forEach(a=>{
      const equip = (a.equipement || a.support || "-");
      const cat   = mapCat[a.categorie] || (a.categorie || "");
      const urgent = !!a.urgent;

      const agent =
        (a.createdBy && (a.createdBy.display || a.createdBy.nom || a.createdBy.matricule)) || "-";

      const desc = (cat ? `[${cat}] ` : "") + (a.description || a.desc || "-");

      anomaliesMat.push({
        support: equip,
        etat: urgent ? "Indispo" : (a.etat || "Mineur"),
        desc,
        agent,
        source: "Patrimoine"
      });
    });

  anomaliesVeh.sort((a,b)=>String(a.support).localeCompare(String(b.support),"fr",{sensitivity:"base"}));
  anomaliesMat.sort((a,b)=>String(a.support).localeCompare(String(b.support),"fr",{sensitivity:"base"}));

  const consignesHasContent = formationListEl && formationListEl.textContent.trim().length > 0;
  if(!consignesHasContent && anomaliesVeh.length===0 && anomaliesMat.length===0){
    alert("Rien √† imprimer (aucune consigne affich√©e, aucune anomalie en cours).");
    return;
  }

  const date = new Date().toLocaleString("fr-FR");

  const w = window.open("", "_blank");
  w.document.write(`
  <html><head>
  <title>Consignes & anomalies</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

    /* ‚úÖ 1 page A4 recto (compact) */
    @page { size: A4; margin: 8mm 7mm; }

    *{ box-sizing:border-box; }
    body{ font-family:Inter,Arial,sans-serif; color:#111; margin:0; }

    header{
      display:flex; align-items:center; gap:8px;
      border-bottom:2px solid #b71c1c;
      padding:4mm 0 2.5mm;
      margin:0 0 2.5mm 0;
    }
    header img{height:14mm;}
    header h1{flex:1;text-align:center;color:#b71c1c;font-size:13pt;margin:0;}
    header .meta{font-size:8.2pt;color:#444;text-align:right;white-space:nowrap; line-height:1.2;}

    h2{color:#0d2b52;font-size:10pt;margin:2.5mm 0 1.5mm 0;}
    .hint{font-size:8.6pt;color:#666;margin:1mm 0 2mm;}

    /* ‚úÖ Consignes : compact + on masque boutons/ic√¥nes √©ventuels */
    .consignes-from-screen .journal-item{
      border:1px solid #e3e6f3; border-radius:6px;
      padding:1.8mm 2.2mm;
      margin:0 0 1.6mm 0;
      break-inside: avoid;
      background:#fff;
    }
    .consignes-from-screen .title{
      font-weight:800; font-size:9.2pt; margin:0 0 0.8mm 0; color:#0d2b52;
    }
    .consignes-from-screen .text{
      font-size:8.6pt; white-space:pre-wrap; line-height:1.2;
    }

    /* Cache des √©l√©ments interactifs si pr√©sents dans la liste */
    .consignes-from-screen button,
    .consignes-from-screen .btn,
    .consignes-from-screen .actions,
    .consignes-from-screen .icon,
    .consignes-from-screen .edit,
    .consignes-from-screen .delete{
      display:none !important;
    }

    /* ‚úÖ Tables anomalies compactes */
    table{width:100%;border-collapse:collapse;font-size:8.4pt; line-height:1.15;}
    th,td{border:1px solid #cfd3df;padding:1.6mm 1.8mm;text-align:left;vertical-align:top;}
    th{background:#f4f6fb;color:#333;font-weight:800;}
    tr:nth-child(even){background:#fafbff;}

    footer{
      margin-top:2.5mm;
      font-size:7.6pt; color:#666;
      border-top:1px solid #eee; padding-top:1.5mm;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* ‚úÖ pas de saut de page + on essaye de tout garder sur 1 page */
    .no-break{ break-inside: avoid; page-break-inside: avoid; }
  </style></head>
  <body>

  <header>
    <img src="https://i.postimg.cc/nnNsr7v1/logo-cismic.png" alt="Logo SDIS 30">
    <h1>Consignes & anomalies</h1>
    <div class="meta">
      Centre : <b>${escapeHtml(cis)}</b><br>
      ${escapeHtml(date)}<br>
      ${escapeHtml(nomComplet || "")}
    </div>
  </header>

  <div class="no-break">
    <h2>üìå Consignes</h2>
    <div class="consignes-from-screen">${consignesHtml}</div>
  </div>

  <div class="no-break">
    <h2>üöí V√©hicules avec anomalies</h2>
    ${
      anomaliesVeh.length
      ? `<table>
          <thead>
            <tr>
              <th style="width:18%">V√©hicule</th>
              <th style="width:14%">√âtat</th>
              <th>Anomalie</th>
              <th style="width:18%">Agent</th>
            </tr>
          </thead>
          <tbody>
            ${anomaliesVeh.map(a=>`<tr>
              <td>${escapeHtml(a.support)}</td>
              <td>${escapeHtml(a.etat)}</td>
              <td>${escapeHtml(a.desc)}</td>
              <td>${escapeHtml(a.agent)}</td>
            </tr>`).join("")}
          </tbody>
        </table>`
      : `<div class="hint">Aucune anomalie v√©hicule en cours.</div>`
    }
  </div>

  <div class="no-break">
    <h2>üè≠ Anomalies mat√©riels</h2>
    ${
      anomaliesMat.length
      ? `<table>
          <thead>
            <tr>
              <th style="width:18%">Mat√©riel</th>
              <th style="width:14%">√âtat</th>
              <th>Anomalie</th>
              <th style="width:18%">Agent</th>
              <th style="width:12%">Source</th>
            </tr>
          </thead>
          <tbody>
            ${anomaliesMat.map(a=>`<tr>
              <td>${escapeHtml(a.support)}</td>
              <td>${escapeHtml(a.etat)}</td>
              <td>${escapeHtml(a.desc)}</td>
              <td>${escapeHtml(a.agent)}</td>
              <td>${escapeHtml(a.source || "‚Äî")}</td>
            </tr>`).join("")}
          </tbody>
        </table>`
      : `<div class="hint">Aucune anomalie mat√©riel en cours.</div>`
    }
  </div>

  <footer>
    <div>Document interne ‚Äî CISMIC</div>
    <div>${escapeHtml(date)}</div>
  </footer>

  <script>window.onload=()=>window.print();<\/script>
  </body></html>`);

  w.document.close();
}


  
/* üëÅÔ∏è Consultation des anomalies d'un v√©hicule (lecture seule) */
function openVehiculeAnomalies(vehName, typeHint){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session") || "null");
    if(!session){ alert("Session expir√©e."); return; }
    const cisSel = Array.isArray(session.cis) ? session.cis[0] : session.cis;

    const vehs = JSON.parse(localStorage.getItem("vehicules_"+cisSel) || "[]");
    const mats = JSON.parse(localStorage.getItem("materiel_"+cisSel) || "[]");
    const patr = JSON.parse(localStorage.getItem("anomalies_"+cisSel) || "[]");

    let source = null;
    let isMateriel = false;

    // si on sait que c'est du mat√©riel, on commence par l√†
    if(typeHint === "materiel"){
      source = mats.find(m => String(m.nom||"").toLowerCase() === String(vehName||"").toLowerCase());
      isMateriel = !!source;
    }
    if(!source){
      // sinon on cherche dans les v√©hicules
      source = vehs.find(v => String(v.nom||"").toLowerCase() === String(vehName||"").toLowerCase());
      isMateriel = false;
      if(!source){
        // dernier recours : mat√©riel
        source = mats.find(m => String(m.nom||"").toLowerCase() === String(vehName||"").toLowerCase());
        if(source) isMateriel = true;
      }
    }


    // üîé Dernier recours : anomalies Patrimoine (page "Anomalies mat√©riel")
    let patrimoineRows = [];
    if(!source){
      const nameLow = String(vehName||"").toLowerCase();
      const list = Array.isArray(patr) ? patr : [];
      const matches = list.filter(a => a && String(a.equipement||"").toLowerCase() === nameLow);
      if(matches.length){
        // On ne montre que les anomalies non cl√¥tur√©es
        patrimoineRows = matches.filter(a => a.cloturee !== "oui");
        if(patrimoineRows.length){
          source = { nom: vehName, history: [] };
          isMateriel = true;
        }
      }
    }
    const title = document.getElementById("anom-title");
    const tbody = document.getElementById("anom-tbody");
    title.textContent = (isMateriel ? "Anomalies mat√©riel ‚Äî " : "Anomalies (en cours) ‚Äî ") + (source ? (source.nom || vehName) : vehName);
    tbody.innerHTML = "";

    // ‚úÖ Affichage Patrimoine
    if(patrimoineRows && patrimoineRows.length){
      const mapCat = {
        menuiserie:"Menuiserie",
        chauffage_clim:"Chauffage clim",
        ecs:"Eau chaude sanitaire",
        ecoulement_bouches:"√âcoulement bouches",
        electricite:"√âlectricit√©",
        fuite_eau:"Fuite d\'eau",
        nuisibles:"Nuisibles",
        portail:"Portail",
        securite_incendie:"S√©curit√© incendie",
        station_carburant:"Station carburant",
        electromenager:"√âlectrom√©nager",
        informatique:"Informatique",
        groupe_electrogene:"Groupe √©lectrog√®ne",
        autre_demande:"Autre demande"
      };
      const catLabel = c => mapCat[c] || (c||"-");

      patrimoineRows
        .sort((a,b)=>{
          const da = String(a.dateSignalement||"");
          const db = String(b.dateSignalement||"");
          return db.localeCompare(da) || ((b.createdTs||0)-(a.createdTs||0));
        })
        .forEach(a=>{
          const tr = document.createElement("tr");
          const statut = a.entreprise ? (a.cloturee==="oui"?"Cl√¥tur√©e":"Intervention") : "Signal√©e";
          const niveau = a.urgent ? "Urgent" : "Normal";
          const desc = `${catLabel(a.categorie)} ‚Äî ${a.zone||"-"}\n${a.description||"-"}`;
          const agent = (a.createdBy && a.createdBy.display) ? a.createdBy.display : "-";
          const dateTxt = a.dateSignalement ? a.dateSignalement : "-";
          tr.innerHTML = `
            <td>${escapeHtml(statut)}</td>
            <td>${escapeHtml(niveau)}</td>
            <td style="white-space:pre-wrap;">${escapeHtml(desc)}</td>
            <td>${escapeHtml(agent)}</td>
            <td>${escapeHtml(dateTxt)}</td>
          `;
          tbody.appendChild(tr);
        });
    }
    else if(!source || !Array.isArray(source.history)){
      tbody.innerHTML = "<tr><td colspan='5' style='padding:10px;color:#666;'>Aucune anomalie en cours.</td></tr>";
    }else{
      const rows = [...source.history]
        .filter(h => !h.closed)
        .sort((a,b)=>{
          const ta = a.timestamp||a.date||0, tb = b.timestamp||b.date||0;
          return (tb - ta) || String(a.text||"").localeCompare(String(b.text||""));
        });

      if(rows.length === 0){
        tbody.innerHTML = "<tr><td colspan='5' style='padding:10px;color:#666;'>Aucune anomalie en cours.</td></tr>";
      }else{
        rows.forEach(h=>{
          const tr = document.createElement("tr");
          const statut = "Ouverte";
          const niveau = h.level || "-";
          const desc   = h.text || "-";
          const agent  = h.agent || "-";
          let dateTxt = "-";
          if(h.date){ dateTxt = h.date; }

          tr.innerHTML = `
            <td>${escapeHtml(dateTxt)}</td>
            <td>${escapeHtml(agent)}</td>
            <td>${escapeHtml(desc)}</td>
            <td>${escapeHtml(niveau)}</td>
            <td>${escapeHtml(statut)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    const modal = document.getElementById("anom-modal");
    if(modal){ modal.style.display = "flex"; }
  }catch(e){
    alert("Impossible d'afficher les anomalies.");
  }
}


/* üìù Main courante : collecte anomalies + entr√©es personnalis√©es */
function renderJournal(){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session") || "null");
    if(!session){ return; }
    const cisSel = Array.isArray(session.cis) ? session.cis[0] : session.cis;

    const vehs   = JSON.parse(localStorage.getItem("vehicules_"+cisSel) || "[]");
    const mats   = JSON.parse(localStorage.getItem("materiel_"+cisSel)  || "[]");
    const custom = JSON.parse(localStorage.getItem("journal_"+cisSel)   || "[]");

    let entries = [];

    // üöí Anomalies v√©hicules
    vehs.forEach(v=>{
      (v.history||[]).forEach(h=>{
        const createdTs = h.timestamp ? Number(h.timestamp) : (Date.parse(h.date||"") || 0);
        const closedTs  = h.closedTs ? Number(h.closedTs) : 0;

        if(h.closed){
          entries.push({
            type: "ANOMALIE",
            ts: closedTs || createdTs,
            title: "Anomalie cl√¥tur√©e ‚Äî " + (v.nom||"-"),
            text: (h.level?("[" + h.level + "] "):"") + (h.text||"-") + (h.closedBy ? (" ‚Äî cl√¥tur√©e par " + h.closedBy) : "")
          });
        }else{
          const who = h.agent ? (" ‚Äî par " + h.agent) : "";
          entries.push({
            type: "ANOMALIE",
            ts: createdTs,
            title: "Anomalie signal√©e ‚Äî " + (v.nom||"-"),
            text: (h.level?("[" + h.level + "] "):"") + (h.text||"-") + who
          });
        }
      });
    });

    // üè≠ Anomalies mat√©riel
    (mats||[]).forEach(m=>{
      (m.history||[]).forEach(h=>{
        const createdTs = h.timestamp ? Number(h.timestamp) : (Date.parse(h.date||"") || 0);
        const closedTs  = h.closedTs ? Number(h.closedTs) : 0;

        if(h.closed){
          entries.push({
            type: "ANOMALIE",
            ts: closedTs || createdTs,
            title: "Anomalie mat√©riel cl√¥tur√©e ‚Äî " + (m.nom||"-"),
            text: (h.level?("[" + h.level + "] "):"") + (h.text||"-") + (h.closedBy ? (" ‚Äî cl√¥tur√©e par " + h.closedBy) : "")
          });
        }else{
          const who = h.agent ? (" ‚Äî par " + h.agent) : "";
          entries.push({
            type: "ANOMALIE",
            ts: createdTs,
            title: "Anomalie mat√©riel signal√©e ‚Äî " + (m.nom||"-"),
            text: (h.level?("[" + h.level + "] "):"") + (h.text||"-") + who
          });
        }
      });
    });

    // üìù Entr√©es personnalis√©es d√©j√† existantes
    if(Array.isArray(custom)){
      custom.forEach(e=>{
        entries.push({
          type: String(e.type||"NOTE").toUpperCase(),
          ts: Number(e.ts||0),
          title: e.title || typeToTitle(String(e.type||"NOTE")),
          text: e.text || ""
        });
      });
    }

    // ‚ùó Exclure les FMA
    entries = entries.filter(e => String(e.type||"").toUpperCase() !== "FMA");

    entries.sort((a,b)=> (Number(b.ts||0) - Number(a.ts||0)) );

    const list = document.getElementById("journal-list");
    if(!list) return;
    list.innerHTML = "";

    if(entries.length === 0){
      list.innerHTML = "<p style='color:#666'>Aucune activit√© r√©cente.</p>";
      return;
    }

    entries.slice(0, 40).forEach(e=>{
      const wrap = document.createElement("div");
      wrap.className = "journal-item";

      const icon = document.createElement("div");
      icon.className = "icon";
      icon.textContent = typeToIcon(e.type);

      const body = document.createElement("div");
      body.className = "body";
      const dateTxt = e.ts ? new Date(e.ts).toLocaleString("fr-FR") : "";
      body.innerHTML = `<div class="title">${escapeHtml(e.title||"")}</div>
                        <div class="text">${escapeHtml(e.text||"")}</div>
                        <div class="date">${escapeHtml(dateTxt)}</div>`;

      wrap.appendChild(icon);
      wrap.appendChild(body);
      list.appendChild(wrap);
    });

  }catch(e){
    console.error("renderJournal error", e);
  }
}


/* üìå Panneau gauche : Consignes du jour (√† la place des FMA) */
function renderFormations(){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return;
    const cisSel = Array.isArray(session.cis) ? session.cis[0] : session.cis;

    const list = document.getElementById("formation-list");
    if(!list) return;

    // üîë Cl√© des consignes (m√™me logique que consignes.html)
    const keyCons = "consignes_"+cisSel;
    let consignes = [];
    try{
      consignes = JSON.parse(localStorage.getItem(keyCons) || "[]");
      if(!Array.isArray(consignes)) consignes = [];
    }catch(_){
      consignes = [];
    }

    // Aujourd‚Äôhui au format ISO "YYYY-MM-DD"
    const todayIso = (() => {
      const d = new Date();
      const p = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    })();

    // Helpers
    const fmtDateFR = (dateStr) => {
      if(!dateStr) return "‚Äî";
      try{
        const d = new Date(dateStr + "T00:00:00");
        if(isNaN(d.getTime())) return dateStr;
        return d.toLocaleDateString("fr-FR");
      }catch(_){ return dateStr; }
    };

    const importanceToLabel = (imp) => {
      switch(imp){
        case "haute":   return "Importante";
        case "moyenne": return "Moyenne";
        case "faible":  return "Faible";
        default:        return "‚Äî";
      }
    };
    const importanceToColor = (imp) => {
      switch(imp){
        case "haute":   return "#d32f2f";
        case "moyenne": return "#fb8c00";
        case "faible":  return "#1976d2";
        default:        return "#1976d2";
      }
    };
    const serviceLabel = (s) => {
      switch(s){
        case "commandement":  return "Commandement";
        case "officier":      return "Officier de garde";
        case "sous-officier": return "Sous-officier de garde";
        default:              return s || "Service";
      }
    };
    const validiteLabel = (v) => {
      switch(v){
        case "jour": return "Jour";
        case "nuit": return "Nuit";
        case "24h":  return "24h";
        default:     return "‚Äî";
      }
    };

    // ‚úÖ Est-ce que la consigne est active MAINTENANT (logique garde 06h‚Üí06h + r√©currence)
    function isActiveNow(c){
      const d1 = (c.dateDebut || "").trim();
      if(!d1) return false;

      const d2 = (c.dateFin || d1).trim();

      const now = new Date();
      const hour = now.getHours();

      // "Jour de garde" = de 06h √† 06h (J+1)
      const serviceBase = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if(hour < 6){
        serviceBase.setDate(serviceBase.getDate() - 1);
      }
      const p = n => String(n).padStart(2,"0");
      const serviceIso = `${serviceBase.getFullYear()}-${p(serviceBase.getMonth()+1)}-${p(serviceBase.getDate())}`;

      // Dans la plage globale ?
      if(serviceIso < d1) return false;
      if(d2 && serviceIso > d2) return false;

      const rec  = (c.recurrence || "none").toLowerCase();
      const per  = Number(c.recurrencePer || 1) || 1;
      const base = d1;

      const baseDate = new Date(base + "T00:00:00");
      if(isNaN(baseDate.getTime())) return false;

      const diffMs   = serviceBase - baseDate;
      const diffDays = Math.floor(diffMs / (1000*60*60*24));

      if(diffDays < 0) return false;

      // üìÖ Gestion de la r√©currence
      switch(rec){
        case "once":
          // Ponctuelle : uniquement sur le jour de d√©but (logique garde)
          if(serviceIso !== d1) return false;
          break;

        case "daily":
          if(diffDays % per !== 0) return false;
          break;

        case "weekly":{
          const semaines = Math.floor(diffDays / 7);
          if(semaines < 0 || (semaines % per) !== 0) return false;
          break;
        }

        case "monthly":{
          const monthsDiff = (serviceBase.getFullYear() - baseDate.getFullYear())*12
                           + (serviceBase.getMonth() - baseDate.getMonth());
          if(monthsDiff < 0 || monthsDiff % per !== 0) return false;
          break;
        }

        case "yearly":{
          const yearsDiff = serviceBase.getFullYear() - baseDate.getFullYear();
          if(yearsDiff < 0 || yearsDiff % per !== 0) return false;
          break;
        }

        case "none":
        default:
          // rien de plus, on reste dans la plage globale
          break;
      }

      const validite = c.validite || "24h";

      // Jour : 06h‚Äì18h
      if(validite === "jour"){
        return (hour >= 6 && hour < 18);
      }

      // Nuit : 18h‚Äì06h
      if(validite === "nuit"){
        return (hour >= 18 || hour < 6);
      }

      // 24h : toute la garde
      return true;
    }

    // üîé Consignes actives pour ce CIS
    const todayConsignes = consignes
      .filter(c => c && c.cis === cisSel)
      .filter(isActiveNow)
      .sort((a,b)=>{
        const ordImp = {haute:0, moyenne:1, faible:2};
        const ia = ordImp[a.importance] ?? 99;
        const ib = ordImp[b.importance] ?? 99;
        if(ia !== ib) return ia - ib;
        const da = a.dateDebut || "";
        const db = b.dateDebut || "";
        return db.localeCompare(da);
      });

    /* üîÅ R√âSERVATIONS V√âHICULES DE LA GARDE COURANTE (06h ‚Üí 06h) */
    let todayRes = [];
    try{
      const keyRes = "reservations_" + cisSel;
      let rawRes = JSON.parse(localStorage.getItem(keyRes) || "[]");

      // Cas √©ventuel objet index√© {"0":{...},"1":{...}}
      if(!Array.isArray(rawRes) && rawRes && typeof rawRes === "object"){
        const keys = Object.keys(rawRes);
        if(keys.length && keys.every(k => /^\d+$/.test(k))){
          rawRes = keys.sort((a,b)=>Number(a)-Number(b)).map(k => rawRes[k]);
        }else{
          rawRes = [];
        }
      }

      // m√™me logique de "jour de garde" que ci-dessus
      const now = new Date();
      const hour = now.getHours();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if(hour < 6){
        base.setDate(base.getDate() - 1);
      }
      const pp = n => String(n).padStart(2,"0");
      const serviceIso = `${base.getFullYear()}-${pp(base.getMonth()+1)}-${pp(base.getDate())}`;

      todayRes = (rawRes || []).filter(r=>{
        if(!r || r.status !== "approved") return false;
        if(r.cis && r.cis !== cisSel) return false;
        const rd1 = (r.dateDebut || r.date || "").trim();
        if(!rd1) return false;
        const rd2 = (r.dateFin || rd1).trim();
        return rd1 <= serviceIso && serviceIso <= rd2;
      });

    }catch(_){
      todayRes = [];
    }

    // üß± Rendu dans le panneau
    list.innerHTML = "";

    const hasCons = todayConsignes.length > 0;
    const hasRes  = todayRes.length > 0;

    if(!hasCons && !hasRes){
      list.innerHTML =
        `<p style="color:#666;font-size:13px;">
          Aucune consigne particuli√®re pour aujourd‚Äôhui (${fmtDateFR(todayIso)}).<br>
          Aucun v√©hicule r√©serv√© pour cette garde.
        </p>`;
      return;
    }

    // üëâ 1) Affichage des CONSIGNES
    if(hasCons){
      todayConsignes.forEach(c=>{
        const wrap = document.createElement("div");
        wrap.className = "journal-item";

        const body = document.createElement("div");
        body.className = "body";

        const periode =
          c.dateDebut && c.dateFin
            ? `Du ${fmtDateFR(c.dateDebut)} au ${fmtDateFR(c.dateFin)}`
            : c.dateDebut
              ? `√Ä partir du ${fmtDateFR(c.dateDebut)}`
              : "P√©riode non renseign√©e";

        const impColor = importanceToColor(c.importance);
        const impLabel = importanceToLabel(c.importance);
        const validTxt = validiteLabel(c.validite);
        const servTxt  = serviceLabel(c.serviceOrigine);

        body.innerHTML = `
  <div class="title" style="display:flex;align-items:center;gap:6px;">
    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${impColor};"></span>
    ${escapeHtml(c.titre || "Consigne")}
  </div>
  <div class="text">${escapeHtml(c.contenu || "")}</div>
`;

        wrap.appendChild(body);
        list.appendChild(wrap);
      });
    }

    // üëâ 2) Affichage des R√âSERVATIONS V√âHICULES
    if(hasRes){
      // petite s√©paration si on a d√©j√† des consignes
      if(hasCons){
        const sep = document.createElement("div");
        sep.style.borderTop = "1px solid #e0e4f0";
        sep.style.margin = "6px 0 4px";
        sep.style.opacity = "0.7";
        list.appendChild(sep);
      }

      const title = document.createElement("div");
      title.style.fontSize = "13px";
      title.style.fontWeight = "700";
      title.style.color = "#0d2b52";
      title.textContent = "üöò R√©servations v√©hicules :";
      list.appendChild(title);

      todayRes.forEach(r=>{
        const wrap = document.createElement("div");
        wrap.className = "journal-item";

        const body = document.createElement("div");
        body.className = "body";

       const veh   = r.vehicule || "V√©hicule √† d√©finir";
const agent = r.agent || "";
const motif = r.motif || "";
const dest  = r.destination || "";
const h1    = r.h1 || "";
const h2    = r.h2 || "";

let line = veh;

// Ajout des heures si disponibles
if(h1 && h2){
  line += ` (${h1}‚Äì${h2})`;
}

line += " r√©serv√©";

if(agent) line += ` par ${agent}`;
if(motif) line += ` pour ${motif}`;
if(dest)  line += ` √† ${dest}`;


        body.innerHTML = `
  <div class="title">${escapeHtml(line)}</div>
`;

        wrap.appendChild(body);
        list.appendChild(wrap);
      });
    }

  }catch(e){
    console.error("Erreur renderFormations/Consignes+R√©servations :", e);
  }
}


function typeToIcon(t){
  switch(String(t).toUpperCase()){
    case "FMA": return "üìò";
    case "PHARMA": return "üíä";
    case "ANOMALIE": return "üöí";
    case "MATERIEL": return "üè≠";
    case "MNR": return "üßØ";
    case "SOG": return "üì£";
    default: return "üìù";
  }
}
function typeToTitle(t){
  switch(String(t).toUpperCase()){
    case "FMA": return "FMA enregistr√©e";
    case "PHARMA": return "Commande pharmacie";
    case "ANOMALIE": return "Anomalie v√©hicule";
    case "MATERIEL": return "Anomalie mat√©riel";
    case "MNR": return "MNR";
    case "SOG": return "Info SOG";
    default: return "Note";
  }
}
function logActivity(type, text, meta){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session") || "null");
    if(!session) return;
    const cisSel = Array.isArray(session.cis) ? session.cis[0] : session.cis;
    const keyJ = "journal_"+cisSel;
    const arr = JSON.parse(localStorage.getItem(keyJ) || "[]");
    const entry = {
      type: String(type||"NOTE").toUpperCase(),
      text: String(text||""),
      ts: Date.now(),
      meta: meta || {},
      title: typeToTitle(type||"NOTE")
    };
    arr.push(entry);
    localStorage.setItem(keyJ, JSON.stringify(arr.slice(-500)));
    renderJournal();
    renderFormations(); // mise √† jour imm√©diate du panneau FMA
  }catch(_){}
}

window.addEventListener("storage",(e)=>{
  try{
    if(!e.key) return;
    const user=JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!user) return;
    const cisSel = Array.isArray(user.cis)?user.cis[0]:user.cis;
    if(e.key===key || e.key==="journal_"+cisSel || e.key==="fma_data_v2" || e.key===("anomalies_"+cisSel)){
      renderMateriel(buildMaterielEtatList(cisSel));
      renderVehicules(JSON.parse(localStorage.getItem(key)||"[]"));
      renderJournal();
      renderFormations();
      renderFmaPendingCard();
    }
    if(e.key === "consignes_"+cisSel){
      renderFormations();
    }
  }catch(_){}
});

  
/* ‚úÖ Purge MC */
function isAdmin(){
  try{
    const u = JSON.parse(localStorage.getItem("csver_session")||"null");
    const role = u && String(u.role||"").toLowerCase();
    if(role === "admin" || role === "commandement") return true; // r√¥le fort
    const perms = getCurrentCisPerms();                           // ‚úÖ droit admin via permissions
    return !!perms.admin;
  }catch(_){ return false; }
}

 // üîê Seul le matricule 1414 est super-admin
function isSuperAdmin() {
    const u = JSON.parse(localStorage.getItem("csver_session") || "null");
    return u && String(u.matricule) === "1414";
}
 
function purgeJournal(scope, evt){  // üîê super admin 1414 OU admin du centre
  if (!isSuperAdmin() && !isAdmin()) {
    alert("Acc√®s refus√© : r√©serv√© √† l'administrateur du centre.");
    return false;
  }
  if(evt && typeof evt.preventDefault === "function") evt.preventDefault();

  const session = JSON.parse(localStorage.getItem("csver_session")||"null");
  if(!session){
    alert("Session expir√©e.");
    return false;
  }

  const cisSel  = Array.isArray(session.cis)?session.cis[0]:session.cis;
  const cisNorm = normCis(cisSel);

  const keyJournal = "journal_"+cisSel;
  const keyVehs    = "vehicules_"+cisSel;
  const keyRes     = "reservations_"+cisSel;
  const keyHab     = "habillement_"+cisSel;      // üÜï demandes habillement

  const K_FMA      = "fma_data_v2";
  const K_REPLI    = "manoeuvre_repli_v1";

  // ===== Lecture brute =====
  const journal = JSON.parse(localStorage.getItem(keyJournal)||"[]");
  const vehs    = JSON.parse(localStorage.getItem(keyVehs)||"[]");
  const keyMat = "materiel_"+cisSel;
renderMateriel(JSON.parse(localStorage.getItem(keyMat)||"[]"));


  // üîÅ R√©servations
  const reservationsRaw = (() => {
    try { return JSON.parse(localStorage.getItem(keyRes) || "[]"); }
    catch(_) { return []; }
  })();

  // üîÅ Habillement
  const habRaw = (() => {
    try { return JSON.parse(localStorage.getItem(keyHab) || "[]"); }
    catch(_) { return []; }
  })();

  // üîÅ FMA (tous centres)
  let fmaAll = [];
  try{
    fmaAll = JSON.parse(localStorage.getItem(K_FMA) || "[]");
  }catch(_){
    fmaAll = [];
  }

  // üîÅ Man≈ìuvres de repli (tous centres)
  let repliAll = [];
  try{
    repliAll = JSON.parse(localStorage.getItem(K_REPLI) || "[]");
  }catch(_){
    repliAll = [];
  }

  // ===== Comptages =====
  const countNotes = Array.isArray(journal) ? journal.length : 0;

  const countAnom  = Array.isArray(vehs)
    ? vehs.reduce((n,v)=> n + ((v.history||[]).length||0), 0)
    : 0;

  let countRes = 0;
  if (Array.isArray(reservationsRaw)) {
    countRes = reservationsRaw.length;
  } else if (reservationsRaw && typeof reservationsRaw === "object") {
    countRes = Object.keys(reservationsRaw).length;
  }

  let countHab = 0; // üî¢ demandes habillement
  if (Array.isArray(habRaw)) {
    countHab = habRaw.length;
  } else if (habRaw && typeof habRaw === "object") {
    countHab = Object.keys(habRaw).length;
  }

  const fmaForCis = Array.isArray(fmaAll)
    ? fmaAll.filter(r => normCis(r.cis) === cisNorm)
    : [];
  const countFma = fmaForCis.length;

  const repliForCis = Array.isArray(repliAll)
    ? repliAll.filter(r => normCis(r.cis) === cisNorm)
    : [];
  const countRepli = repliForCis.length;

  // ===== Message de confirmation =====
  let msg = "";
  if(scope === "notes"){
    msg = `‚ö†Ô∏è Cette action va supprimer ${countNotes} note(s) personnalis√©e(s) de la main courante pour le CIS ‚Äú${cisSel}‚Äù.\n\nContinuer ?`;
  }else{
    msg = `‚ö†Ô∏è PURGE COMPL√àTE\n\n` +
          `- Notes personnalis√©es : ${countNotes}\n` +
          `- Entr√©es d'anomalies (tous v√©hicules) : ${countAnom}\n` +
          `- R√©servations v√©hicules : ${countRes}\n` +
          `- Demandes habillement : ${countHab}\n` +           // üÜï
          `- FMA enregistr√©es : ${countFma}\n` +
          `- Man≈ìuvres de repli : ${countRepli}\n\n` +
          `Cette action est irr√©versible. Confirmez pour TOUT effacer pour le CIS ‚Äú${cisSel}‚Äù.`;
  }

  if(!confirm(msg)) return false;

  // ===== Sauvegarde JSON (optionnelle) =====
  if(
    (countNotes>0 || countAnom>0 || countRes>0 || countHab>0 || countFma>0 || countRepli>0) &&
    confirm("Souhaitez-vous t√©l√©charger une sauvegarde (.json) avant suppression ?")
  ){
    try{
      const backup = {
        cis: cisSel,
        ts: Date.now(),
        scope,
        notes:       journal,
        vehicules:   vehs,
        reservations: reservationsRaw,
        habillement:  habRaw,        // üÜï demandes habillement du CIS
        fma:         fmaForCis,
        repli:       repliForCis
      };
      const blob = new Blob([JSON.stringify(backup,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      const stamp = new Date().toISOString().replace(/[:.]/g,"-");
      a.download = `backup_purge_${cisSel}_${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 0);
    }catch(_){}
  }

  // ===== Purge effective =====
  try{
    // üßπ 1) main courante (toujours)
    localStorage.removeItem(keyJournal);

    if(scope === "all"){
      // üßπ 2) anomalies v√©hicules
      if(Array.isArray(vehs)){
        const cleaned = vehs.map(v=>{
          const nv = Object.assign({}, v);
          nv.history = [];
          return nv;
        });
        localStorage.setItem(keyVehs, JSON.stringify(cleaned));
      }

      // üßπ 3) toutes les r√©servations du CIS
      localStorage.removeItem(keyRes);

      // üßπ 4) toutes les demandes habillement du CIS
      localStorage.removeItem(keyHab);

      // üßπ 5) FMA du CIS seulement
      if(Array.isArray(fmaAll) && countFma > 0){
        const remainingFma = fmaAll.filter(r => normCis(r.cis) !== cisNorm);
        localStorage.setItem(K_FMA, JSON.stringify(remainingFma));
      }

      // üßπ 6) man≈ìuvres de repli du CIS seulement
      if(Array.isArray(repliAll) && countRepli > 0){
        const remainingRepli = repliAll.filter(r => normCis(r.cis) !== cisNorm);
        localStorage.setItem(K_REPLI, JSON.stringify(remainingRepli));
      }
    }

    // ===== Rafra√Æchissement accueil & overlays si dispo =====
    renderJournal?.();
    renderFormations?.();

    if (typeof renderVehicules === "function") {
      const newVehs = JSON.parse(localStorage.getItem(keyVehs)||"[]");
      renderVehicules(newVehs);
    }

    if (typeof renderReservationsPendingOverlay === "function") {
      renderReservationsPendingOverlay();
    }

    alert(scope==="notes"
      ? "Main courante (notes) vid√©e."
      : "Purge compl√®te effectu√©e (notes, anomalies, r√©servations, habillement, FMA, man≈ìuvres de repli)."
    );
  }catch(e){
    alert("Erreur pendant la purge.");
  }
  return false;
}



</script>

<!-- AJOUT : Script Mes FMA autonome (aucune collision) -->
<script>
(function(){
  function mf_tidy(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function mf_strip(s){ try{ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch(_){ return s; } }
  function mf_key(raw){
    const s = mf_strip(mf_tidy(raw).toLowerCase());
    const p = s.split(" ").filter(Boolean);
    if(p.length===2){ const a=p[0], b=p[1]; return [a,b].sort().join("_"); }
    return p.join("_");
  }
  function mf_hhmm(min){ if(!min||isNaN(min))return ""; const h=Math.floor(min/60),m=min%60; return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"); }
  function mf_dFR(iso){ try{ return new Date(iso).toLocaleDateString("fr-FR"); }catch(_){ return iso||""; } }
// --- Man≈ìuvre de repli : helpers ---
  const MF_REPLI_KEY = "manoeuvre_repli_v1";

  function mf_daysSince(dateIso){
    if(!dateIso) return null;
    const d = new Date(dateIso + "T00:00:00");
    if(isNaN(d.getTime())) return null;
    const today = new Date();
    const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const t1 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const diffMs = t0 - t1;
    return Math.floor(diffMs / (1000*60*60*24));
  }

  function mf_session(){
    try{
      return JSON.parse(localStorage.getItem("csver_session") || "null");
    }catch(_){ return null; }
  }

  // Retourne {date, days} pour la derni√®re man≈ìuvre de repli de l'agent courant, ou null
  function mf_lastRepliForMe(){
    const s = mf_session();
    if(!s) return null;

    const cisSess = Array.isArray(s.cis) ? (s.cis[0] || "") : (s.cis || "");
    // cl√© normalis√©e de l'agent (m√™me principe que pour les FMA)
    const meKey = mf_key(((s.nom||"") + " " + (s.prenom||"")).trim() || s.matricule || "");

    let all = [];
    try{
      all = JSON.parse(localStorage.getItem(MF_REPLI_KEY) || "[]");
      if(!Array.isArray(all)) all = [];
    }catch(_){ all = []; }

    // filtre sur le CIS courant
    const filtered = all.filter(r => {
      try{
        return normCis(r.cis) === normCis(cisSess);
      }catch(_){
        return false;
      }
    });

    // On cherche la plus r√©cente pour cet agent
    let lastDate = null;
    filtered.forEach(rec => {
      (rec.agents || []).forEach(a => {
        if(mf_key(a.name || "") === meKey){
          if(!lastDate || String(rec.date||"") > String(lastDate)){
            lastDate = rec.date || null;
          }
        }
      });
    });

    if(!lastDate) return null;
    const days = mf_daysSince(lastDate);
    return { date: lastDate, days };
  }

  // Met √† jour la ligne "Derni√®re man≈ìuvre de repli" dans la modale Mes FMA
  function mf_renderRepliLine(){
    const el = document.getElementById("myfma-repli");
    if(!el) return;

    const info = mf_lastRepliForMe();
    if(!info){
      el.innerHTML = `<span style="color:#c62828">
        Derni√®re man≈ìuvre de repli : jamais enregistr√©e
      </span>`;
      return;
    }

    const dTxt = mf_dFR(info.date);
    const d    = info.days==null ? "?" : info.days;
    let color  = "#c62828";
    let label  = "‚â• 15 jours";

    if(info.days != null){
      if(info.days < 10){
        color = "#0a8a3a";
        label = "&lt; 10 jours";
      }else if(info.days <= 14){
        color = "#ff9800";
        label = "10 √† 14 jours";
      }else{
        color = "#c62828";
        label = "‚â• 15 jours";
      }
    }

    el.innerHTML = `
      <span style="color:${color}">
        Derni√®re man≈ìuvre de repli : ${dTxt} (${d} jour(s), ${label})
      </span>
    `;
  }
  function mf_ctx(){
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return null;
    const userDisplay = mf_tidy(((session.prenom||"")+" "+(session.nom||"")).trim() || session.matricule || "Agent");
    const userKey = mf_key(userDisplay);
    const fmas = JSON.parse(localStorage.getItem("fma_data_v2")||"[]");
    let themes = JSON.parse(localStorage.getItem("csver_themes")||"null");
    if(!themes || !Array.isArray(themes) || !themes.length){
      themes = ["ARI / Reconnaissance","√âchelle √† coulisse","Sauvetage / LSPCC","√âtablissements / Alimentation","Feu de v√©hicule","Secours routier","Manoeuvre hydraulique"];
    }
    return { userDisplay, userKey, fmas, themes };
  }

  function mf_filterMine(ctx){
    const me = ctx.userKey;
    const rows=[];
    for(const r of ctx.fmas){
      const isFormateur = mf_key(r.formateur||"")===me;
      const inParticipants = Array.isArray(r.participants) && r.participants.some(p=> mf_key(p.name||"")===me);
      if(isFormateur || inParticipants){
        rows.push({
          date:r.date, h1:r.h1, h2:r.h2, theme:r.theme, formateur:r.formateur||"",
          participants:(r.participants||[]).map(p=>`${p.name}${p.role? " ("+p.role+")":""}`).join(", "),
          role:isFormateur?"Formateur":"Participant",
          minutes:Number(r.dureeMin||0),
          webact:r.webact&&r.webact.done?"‚úÖ Saisie OK":"‚è≥ √Ä saisir"
        });
      }
    }
    return rows.sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));
  }

  function mf_summary(ctx, myRows){
    const map=new Map(); ctx.themes.forEach(t=>map.set(t,0));
    for(const r of myRows){ if(!map.has(r.theme)) map.set(r.theme,0); map.set(r.theme,map.get(r.theme)+(r.minutes||0)); }
    return ctx.themes.map(t=>({ theme:t, minutes:map.get(t)||0, status:(map.get(t)||0)>0?"OK":"√Ä faire" }));
  }

  window.openMyFma = function(evt){
    if(evt && typeof evt.preventDefault==="function") evt.preventDefault();

    const ctx = mf_ctx(); if(!ctx){ alert("Session expir√©e."); return false; }
    const mine = mf_filterMine(ctx);
    const sum  = mf_summary(ctx, mine);

    const u = document.getElementById("myfma-username");
    const c = document.getElementById("myfma-count");
    if(u) u.textContent = ctx.userDisplay;
    if(c) c.textContent = `‚Äî ${mine.length} FMA trouv√©e(s)`;

    const body = document.getElementById("myfma-body");
    if(body){
      body.innerHTML = mine.map(r=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid #eee;">${mf_dFR(r.date)}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${r.h1||"--"}‚Äì${r.h2||"--"}<br><span style="color:#666;font-size:12px">${mf_hhmm(r.minutes)}</span></td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${r.theme||"-"}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${r.role}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${r.formateur||"-"}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${r.participants||"-"}<br><span style="color:#666;font-size:12px">${r.webact}</span></td>
        </tr>`).join("") || `<tr><td colspan="6" style="padding:10px;color:#666">Aucune FMA enregistr√©e te concernant.</td></tr>`;
    }

    const tBody = document.getElementById("myfma-theme");
    if(tBody){
      tBody.innerHTML = sum.map(s=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid #eee;">${s.theme}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">${mf_hhmm(s.minutes)}</td>
          <td style="padding:8px;border-bottom:1px solid #eee;">
            <span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid ${s.status==="OK"?"#a7e2be":"#ffd39b"};background:${s.status==="OK"?"#e6f7ec":"#fff4e5"};color:${s.status==="OK"?"#0a8a3a":"#a36100"};font-weight:700;font-size:12px">${s.status}</span>
          </td>
        </tr>`).join("");
    }

    const modal = document.getElementById("myfma-modal");
    if(modal) modal.style.display = "flex";
    const closeBtn = document.getElementById("myfma-close");
    if(closeBtn) closeBtn.onclick = ()=>{ modal.style.display="none"; };
    if(modal){
      modal.addEventListener("click",(e)=>{ if(e.target===modal){ modal.style.display="none"; } });
      document.addEventListener("keydown", function esc(e){ if(e.key==="Escape"&&modal.style.display!=="none"){ modal.style.display="none"; document.removeEventListener("keydown", esc); } });
    }

    // Met √† jour la ligne "Derni√®re man≈ìuvre de repli"
    mf_renderRepliLine();
    
    return false;
  };
})();
</script>
<!-- FIN AJOUT -->

<!-- AJOUT : Modale Mes FMA (ordre invers√© : Synth√®se en haut, R√©alis√©es en bas) -->
<div id="myfma-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2100;align-items:center;justify-content:center;padding:20px;">
  <div style="background:#fff;border-radius:14px;max-width:1100px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:#0d2b52;color:#fff;">
      <h3 style="font-size:18px;font-weight:700;">üë§ Mes FMA</h3>
      <button id="myfma-close" style="background:#b71c1c;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;">Fermer</button>
    </div>

    <div style="padding:16px 20px;max-height:70vh;overflow:auto;">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
        <strong id="myfma-username"></strong>
        <span id="myfma-count" style="color:#555"></span>
      </div>

      <!-- üß≠ Synth√®se par th√®me (EN HAUT) -->
      <h4 style="margin:10px 0 6px;color:#0d2b52">üß≠ Synth√®se par th√®me</h4>
      <div class="myfma-scroll" style="overflow:auto">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Th√®me</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Temps r√©alis√©</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Statut</th>
            </tr>
          </thead>
          <tbody id="myfma-theme"></tbody>
        </table>
      </div>
      <p style="margin-top:8px;color:#666;font-size:13px">Statut ‚Äú√Ä faire‚Äù = aucun enregistrement trouv√© pour ce th√®me.</p>

<!-- üîÅ Derni√®re man≈ìuvre de repli (ligne au-dessus des FMA r√©alis√©es) -->
      <div id="myfma-repli" style="margin:12px 0 4px;font-size:15px;font-weight:700;"></div>

      <!-- üìú Mes FMA r√©alis√©es (EN BAS) -->
      <h4 style="margin:18px 0 6px;color:#0d2b52">üìú Mes FMA r√©alis√©es</h4>
      <div class="myfma-scroll" style="overflow:auto">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Date</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Heures</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Th√®me</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">R√¥le</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Formateur</th>
              <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Participants</th>
            </tr>
          </thead>
          <tbody id="myfma-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- FIN AJOUT -->

<!-- Modal anomalies (inchang√©) -->
<div id="anom-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;align-items:center;justify-content:center;padding:20px;">
  <div style="background:#fff;border-radius:14px;max-width:900px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:#0d2b52;color:#fff;">
      <h3 id="anom-title" style="font-size:18px;font-weight:700;">Anomalies</h3>
      <button id="anom-close" style="background:#b71c1c;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;">Fermer</button>
    </div>
    <div id="anom-content" style="padding:16px 20px;max-height:65vh;overflow:auto;">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Statut</th>
            <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Niveau</th>
            <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Description</th>
            <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Agent</th>
            <th style="text-align:left;border-bottom:2px solid #eee;padding:8px;">Date</th>
          </tr>
        </thead>
        <tbody id="anom-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById("anom-modal");
  const closeBtn = document.getElementById("anom-close");
  if(closeBtn){ closeBtn.addEventListener("click", ()=>{ if(modal){ modal.style.display="none"; } }); }
  if(modal){
    modal.addEventListener("click",(e)=>{ if(e.target===modal){ modal.style.display="none"; } });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"&&modal.style.display!=="none"){ modal.style.display="none"; } });
  }
})();
</script>

<!-- üßæ LOGIQUE OVERLAY FMA A SAISIR -->
<script>
/* Helpers droits "Saisie FMA" + admin-like */
function isAdminLike(){
  try{
    const s = JSON.parse(localStorage.getItem("csver_session")||"null");
    const r = s && String(s.role||"").toLowerCase();
    return r === "admin" || r === "commandement";
  }catch(_){ return false; }
}
function hasSaisieFma(){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return false;
    const fiche = JSON.parse(localStorage.getItem("csver_user_"+session.matricule) || "null");
    if(!fiche || !fiche.permissions) return false;
    const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;

    // R√©cup√®re le bloc de permissions pertinent (principal vs secondaire)
    let perms = null;
    const cisPrim = fiche.cis && fiche.cis.primary ? fiche.cis.primary : null;
    const isPrim = cisPrim && normCis(cisPrim) === normCis(cisCur);
    if(isPrim) perms = fiche.permissions.primary || null;
    else{
      const sec = fiche.permissions.secondaries || {};
      perms = sec[cisCur] || sec[Object.keys(sec).find(k => normCis(k)===normCis(cisCur))] || null;
    }
    if(!perms) return false;

    // Tol√©rant sur le nom de la cl√© (suivant comment tu l‚Äôas ajout√©e dans l‚Äôadmin)
    return !!(perms.saisieFma || perms.saisie_fma || perms.saisiefma);
  }catch(_){ return false; }
}

/* R√©cup√®re les FMA √† saisir pour mon CIS courant */
function getPendingForMyCis(limit=6){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return [];
    const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
    const data = JSON.parse(localStorage.getItem("fma_data_v2")||"[]");
    const rows = (Array.isArray(data)?data:[])
      .filter(r => !r?.webact?.done)
      .filter(r => normCis(r?.cis||"") === normCis(cisCur||""))
      .sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));
    return typeof limit==="number" ? rows.slice(0, limit) : rows;
  }catch(_){ return []; }
}

/* Affiche/masque l‚Äôoverlay et remplit le tableau */
function renderFmaPendingCard(){
  const maySee = hasSaisieFma() || isAdminLike();
  const overlay = document.getElementById('fmaOverlay');
  const card = document.getElementById('fmaPendingCard');
  const tBody = document.getElementById('fmaPendingBody');
  const badge = document.getElementById('fmaPendingCount');
  if(!overlay || !card || !tBody || !badge) return;

  if(!maySee){
    overlay.style.display = 'none';
    return;
  }

  const all = getPendingForMyCis(null);
  if(!all.length){
    overlay.style.display = 'none';
    return;
  }

  // contenu
  badge.textContent = `${all.length}`;
  tBody.innerHTML = all.slice(0,10).map(r=>{
    const d = (()=>{ try{ return new Date(r.date).toLocaleDateString("fr-FR"); }catch(_){ return r.date||"-"; }})();
    return `<tr><td>${d}</td><td>${escapeHtml(r.theme||"-")}</td><td>${escapeHtml(r.formateur||"-")}</td></tr>`;
  }).join("");

  // handlers
  const go = document.getElementById('fmaGoBtn');
  const ok = document.getElementById('fmaDismissBtn');
  if(go) go.onclick = (e)=>{ openLink('fma.html', e); };
  if(ok) ok.onclick = ()=>{ overlay.style.display='none'; };

  // clic arri√®re-plan
  overlay.onclick = (e)=>{ if(e.target === overlay) overlay.style.display='none'; };

  // √©chap
  document.addEventListener('keydown', function esc(ev){
    if(ev.key === 'Escape' && overlay.style.display !== 'none'){
      overlay.style.display='none';
      document.removeEventListener('keydown', esc);
    }
  });

  // montre l‚Äôoverlay
  overlay.style.display = 'flex';
}
</script>
<script>
/* ===========================
   üîî Overlay "R√©servations en attente" ‚Äî Accueil
   =========================== */

/* üëâ Chemin de ta page r√©servations (m√™me que dans ton menu) */
const RES_PAGE_HREF = "reservations_vehicules.html";

/* R√¥les autoris√©s : SPP / SOG / Admin / Commandement, ou permission fine ‚Äúv√©hicules‚Äù */
function canSeeReservationsOverlay(){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return false;
    const role = String(session.role||"").toLowerCase();
    if(["spp","sog spv","sog","admin","commandement"].includes(role)) return true;

    // Permissions fines (comme applyRoleMenus)
    const fiche = JSON.parse(localStorage.getItem("csver_user_"+session.matricule)||"null");
    const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
    if(fiche && fiche.permissions){
      const norm = s => String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();
      const cisPrim = fiche.cis && fiche.cis.primary ? fiche.cis.primary : null;
      const isPrim  = cisPrim && (norm(cisPrim) === norm(cisCur));
      let perms = null;
      if(isPrim) perms = fiche.permissions.primary || null;
      else{
        const sec = fiche.permissions.secondaries || {};
        const key = Object.keys(sec).find(k => norm(k) === norm(cisCur));
        perms = sec[cisCur] || (key ? sec[key] : null);
      }
      if(perms && (perms["v√©hicules"] || perms.admin)) return true;
    }
  }catch(_){}
  return false;
}

/* Lecture des demandes en attente pour le CIS courant */
function getPendingReservations(limit = 6){
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return [];
    const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
    const keyRes = "reservations_"+cisCur;
    const rows = (JSON.parse(localStorage.getItem(keyRes)||"[]")||[])
      .filter(r => r.status === "pending")
      .sort((a,b)=> a.date===b.date ? a.m1-b.m1 : a.date.localeCompare(b.date));
    return typeof limit==="number" ? rows.slice(0, limit) : rows;
  }catch(_){ return []; }
}

/* Rendu de l‚Äôoverlay ‚Äî TOUJOURS afficher s‚Äôil reste des "pending" */
function renderReservationsPendingOverlay(){
  const maySee = canSeeReservationsOverlay();
  const overlay = document.getElementById('resOverlay');
  const body    = document.getElementById('resPendingBody');
  const badge   = document.getElementById('resPendingCount');
  const btnGo   = document.getElementById('resGoBtn');
  const btnOk   = document.getElementById('resDismissBtn');
  if(!overlay || !body || !badge || !btnGo || !btnOk) return;

  if(!maySee){
    overlay.style.display = 'none';
    return;
  }

  const pending = getPendingReservations(null);
  const count = pending.length;

  if(count <= 0){
    overlay.style.display = 'none';
    return;
  }

  // Contenu du tableau
  body.innerHTML = pending.slice(0,10).map(r=>{
    const dateFR = (()=>{
      try{ const [Y,M,D] = String(r.date||"").split("-"); return [D,M,Y].join("-"); }
      catch(_){ return r.date||"-"; }
    })();
    const heures = `${r.h1||"--:--"}‚Äì${r.h2||"--:--"}`;
    return `<tr>
      <td>${dateFR}</td>
      <td>${heures}</td>
      <td>${escapeHtml(r.agent||"-")}</td>
      <td>${escapeHtml(r.motif||"-")}</td>
      <td>${escapeHtml(r.destination||"-")}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="5" style="padding:10px;color:#666">Aucune demande en attente.</td></tr>`;

  badge.textContent = String(count);

  // Actions
  btnGo.onclick = (e)=>{ 
    // va sur la page de r√©servations
    if(e && typeof e.preventDefault==="function") e.preventDefault();
    try{ openLink(RES_PAGE_HREF, e); } catch(_){ window.location.href = RES_PAGE_HREF; }
  };
  btnOk.onclick = ()=>{ 
    // on ferme juste pour le moment ; il se re-montrera d√®s qu‚Äôon revient / refocus tant qu‚Äôil reste du pending
    overlay.style.display='none';
  };

  // Fermer sur clic ext√©rieur / Esc (r√©-appara√Ætra au prochain focus/chargement si des pending restent)
  overlay.onclick = (e)=>{ if(e.target===overlay){ overlay.style.display='none'; } };
  document.addEventListener('keydown', function esc(ev){
    if(ev.key==="Escape" && overlay.style.display!=="none"){
      overlay.style.display='none';
      document.removeEventListener('keydown', esc);
    }
  });

  overlay.style.display = 'flex';
}

/* Hooks */
window.addEventListener("DOMContentLoaded", ()=>{ setTimeout(()=>renderReservationsPendingOverlay(), 250); });
window.addEventListener("focus", ()=>renderReservationsPendingOverlay());
window.addEventListener("pageshow", ()=>renderReservationsPendingOverlay());
window.addEventListener("storage",(e)=>{
  try{
    const session = JSON.parse(localStorage.getItem("csver_session")||"null");
    if(!session) return;
    const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
    if(e.key === "reservations_"+cisCur){
      renderReservationsPendingOverlay();
    }
  }catch(_){}
});
</script>

<!-- üîî Overlay "D√©p√¥ts habillement" ‚Äî Script (AJOUT MINIMAL) -->
<script>
const HABILLEMENT_PAGE_HREF = "gestion_habillement.html";

/* ‚úÖ Droit explicite ‚Äúgestion habillement‚Äù (tol√©rant sur le nom de cl√©) */
function hasGestionHabillement(){
  try{
    const perms = getCurrentCisPerms() || {};
    const keys = [
      "gestion_habillement","gestionHabillement","gestion-habillement",
      "habillement_gestion","habillementGestion"
    ];
    return keys.some(k => !!perms[k]);
  }catch(_){ return false; }
}

/* ‚ùå Plus de d√©rogation admin/commandement ‚Äî seul le droit ci-dessus compte */
function canSeeHabillementOverlay(){
  return hasGestionHabillement();
}

function habCtx(){
  const session = JSON.parse(localStorage.getItem("csver_session")||"null");
  if(!session) return null;
  const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
  return {
    session,
    cis: cisCur,
    dataKey: "habillement_"+cisCur,
    seenKey: "habillement_seen_"+session.matricule+"_"+cisCur
  };
}
function habReadAll(ctx){
  try{ const a = JSON.parse(localStorage.getItem(ctx.dataKey)||"[]"); return Array.isArray(a)?a:[]; }
  catch(_){ return []; }
}
function habGetSeen(ctx){
  const v = localStorage.getItem(ctx.seenKey);
  return v ? parseInt(v,10) : 0;
}
function habMaxCreatedTs(ctx){
  let max = 0;
  for(const r of habReadAll(ctx)){ if(r && r.createdTs && r.createdTs>max) max = r.createdTs; }
  return max;
}
function habMarkSeen(ctx){
  localStorage.setItem(ctx.seenKey, String(habMaxCreatedTs(ctx) || Date.now()));
}

function renderHabillementOverlay(){
  const overlay = document.getElementById("habOverlay");
  const body    = document.getElementById("habPendingBody");
  const badge   = document.getElementById("habPendingCount");
  const btnGo   = document.getElementById("habGoBtn");
  const btnSeen = document.getElementById("habSeenBtn");
  if(!overlay || !body || !badge || !btnGo || !btnSeen) return;

  if(!canSeeHabillementOverlay()){
    overlay.style.display = "none";
    return;
  }

  const ctx = habCtx();
  if(!ctx){ overlay.style.display="none"; return; }

  const seenTs = habGetSeen(ctx);
  const all    = habReadAll(ctx);

const news = all.filter(x => {
    const created = x?.createdTs || 0;
    const treated = x?.status?.traite?.done === true;
    return created > seenTs && !treated;
});



  if(news.length === 0){
    overlay.style.display = "none";
    return;
  }

  news.sort((a,b)=> (String(b.date||"").localeCompare(String(a.date||""))) || ((b.createdTs||0)-(a.createdTs||0)));
  body.innerHTML = news.slice(0,10).map(e=>{
    const dateFR = (()=>{
      try{ const [Y,M,D] = String(e.date||"").split("-"); return [D,M,Y].join("-"); }
      catch(_){ return e.date||"-"; }
    })();
    const effets = Array.isArray(e.effets) && e.effets.length
      ? e.effets.map(x=>`${escapeHtml(x.article||"-")} √ó ${x.qte||1}${x.obs? " ‚Äî "+escapeHtml(x.obs):""}`).join("<br>")
      : "-";
    return `<tr>
      <td>${dateFR}</td>
      <td>${escapeHtml(e.agent||"-")}</td>
      <td>${escapeHtml(e.matricule||"-")}</td>
      <td>${effets}</td>
    </tr>`;
  }).join("");

  badge.textContent = String(news.length);

  btnGo.onclick   = (e)=>{ openLink(HABILLEMENT_PAGE_HREF, e); };
  btnSeen.onclick = ()=>{ habMarkSeen(ctx); overlay.style.display="none"; };

  overlay.onclick = (e)=>{ if(e.target===overlay){ overlay.style.display="none"; } };
  document.addEventListener("keydown", function esc(ev){
    if(ev.key==="Escape" && overlay.style.display!=="none"){
      overlay.style.display = "none";
      document.removeEventListener("keydown", esc);
    }
  });

  overlay.style.display = "flex";
}

window.addEventListener("DOMContentLoaded", ()=>{ setTimeout(()=>renderHabillementOverlay(), 300); });
window.addEventListener("focus", ()=>renderHabillementOverlay());
window.addEventListener("pageshow", ()=>renderHabillementOverlay());
window.addEventListener("storage",(e)=>{
  try{
    const ctx = habCtx(); if(!ctx) return;
    if(e.key === ctx.dataKey){ renderHabillementOverlay(); }
  }catch(_){}
});
</script>


<script>
/* ===========================
   üì¨ Overlay "Nouveaux messages" ‚Äî Accueil
   =========================== */

const MESSAGE_PAGE_HREF = "messagerie.html"; // ‚¨Ö adapte si besoin

// üîπ Contexte : messages du CIS + messages globaux inter-CIS
function mailCtx(){
  const session = JSON.parse(localStorage.getItem("csver_session")||"null");
  if(!session) return null;
  const cisCur = Array.isArray(session.cis)?session.cis[0]:session.cis;
  return {
    session,
    cis: cisCur,
    keyLocal:  "messages_"+cisCur, // messages internes au centre
    keyGlobal: "messages__ALL_"    // messages inter-CIS / broadcast
  };
}

function fmtDateMail(ts){
  try{
    const d=new Date(Number(ts)||0);
    const p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }catch(_){ return "‚Äî"; }
}

/* üîç R√©cup√®re le tableau des destinataires, quel que soit le nom du champ */
function getRecipients(msg){
  if (Array.isArray(msg.to)) return msg.to;
  if (Array.isArray(msg.destinataires)) return msg.destinataires;
  if (Array.isArray(msg.recipients)) return msg.recipients;
  return [];
}

/* üîç R√©cup√®re la map "lus" */
function getReadMap(msg){
  if (msg.readBy && typeof msg.readBy === "object") return msg.readBy;
  if (msg.luPar  && typeof msg.luPar  === "object") return msg.luPar;
  return {};
}

/* Renvoie la liste des messages non lus pour l‚Äôagent courant
   ‚Üí fusion messages_<CIS> + messages__ALL_
*/
function getUnreadForMe(limit=10){
  const ctx = mailCtx(); 
  if(!ctx) return [];

  const me = String(ctx.session.matricule||"");

  let arrLocal  = [];
  let arrGlobal = [];

  try{
    arrLocal = JSON.parse(localStorage.getItem(ctx.keyLocal) || "[]");
    if(!Array.isArray(arrLocal)) arrLocal = [];
  }catch(_){ arrLocal = []; }

  try{
    arrGlobal = JSON.parse(localStorage.getItem(ctx.keyGlobal) || "[]");
    if(!Array.isArray(arrGlobal)) arrGlobal = [];
  }catch(_){ arrGlobal = []; }

  const combined = arrLocal.concat(arrGlobal);

  const rows   = [];
  const seenId = new Set();

  combined.forEach(m=>{
    if(!m) return;

    const id = m.id || m.uid || null;
    if(id && seenId.has(id)) return;
    if(id) seenId.add(id);

    const recips = getRecipients(m);
    const toMe = recips.some(r=>{
      const rMat = String(r.matricule || r.id || "").trim();
      return rMat === me;
    });
    if(!toMe) return;

    const readMap = getReadMap(m);
    if(readMap[me]) return; // d√©j√† lu

    rows.push(m);
  });

  rows.sort((a,b)=>{
    const ta = Number(a.ts || a.timestamp || 0);
    const tb = Number(b.ts || b.timestamp || 0);
    return tb - ta;
  });

  return (typeof limit==="number") ? rows.slice(0,limit) : rows;
}

/* Marque comme lus (pour MOI) dans messages_<CIS> ET messages__ALL_ */
function markMyMailsAsRead(){
  const ctx = mailCtx(); 
  if(!ctx) return;

  const me = String(ctx.session.matricule||"");

  let arrLocal  = [];
  let arrGlobal = [];

  try{
    arrLocal = JSON.parse(localStorage.getItem(ctx.keyLocal) || "[]");
    if(!Array.isArray(arrLocal)) arrLocal = [];
  }catch(_){ arrLocal = []; }

  try{
    arrGlobal = JSON.parse(localStorage.getItem(ctx.keyGlobal) || "[]");
    if(!Array.isArray(arrGlobal)) arrGlobal = [];
  }catch(_){ arrGlobal = []; }

  function markArray(arr){
    let touched = false;
    (Array.isArray(arr)?arr:[]).forEach(m=>{
      if(!m) return;
      const recips = getRecipients(m);
      const toMe = recips.some(r=>{
        const rMat = String(r.matricule || r.id || "").trim();
        return rMat === me;
      });
      if(!toMe) return;

      const readMap = getReadMap(m);
      if(!readMap[me]){
        // on force la map dans le message au format readBy
        m.readBy = readMap;
        m.readBy[me] = true;
        touched = true;
      }
    });
    return touched;
  }

  const touchedLocal  = markArray(arrLocal);
  const touchedGlobal = markArray(arrGlobal);

  if(touchedLocal){
    localStorage.setItem(ctx.keyLocal, JSON.stringify(arrLocal));
  }
  if(touchedGlobal){
    localStorage.setItem(ctx.keyGlobal, JSON.stringify(arrGlobal));
  }
}

/* Rend et affiche/masque l‚Äôoverlay */
function renderMailOverlay(){
  const overlay = document.getElementById("mailOverlay");
  const body    = document.getElementById("mailPendingBody");
  const badge   = document.getElementById("mailPendingCount");
  const btnGo   = document.getElementById("mailGoBtn");
  const btnRead = document.getElementById("mailMarkReadBtn");
  if(!overlay || !body || !badge || !btnGo || !btnRead) return;

  const ctx = mailCtx();
  if(!ctx){ overlay.style.display="none"; return; }

  const unread = getUnreadForMe(null);
  if(unread.length === 0){
    overlay.style.display = "none";
    return;
  }

  badge.textContent = String(unread.length);
  body.innerHTML = unread.slice(0,10).map(m=>{
    const fromName = (m.from && m.from.display) ? m.from.display : (m.fromName || "-");
    const subject  = m.subject || m.objet || "-";
    const ts       = m.ts || m.timestamp;

    const esc = s => String(s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    return `
      <tr>
        <td>${fmtDateMail(ts)}</td>
        <td>${esc(fromName)}</td>
        <td>${esc(subject)}</td>
      </tr>
    `;
  }).join("");

  btnGo.onclick   = (e)=>{ 
    if(e && e.preventDefault) e.preventDefault();
    try{ openLink(MESSAGE_PAGE_HREF, e); }
    catch(_){ window.location.href = MESSAGE_PAGE_HREF; }
  };
  btnRead.onclick = ()=>{ 
    markMyMailsAsRead();
    overlay.style.display="none"; 
  };

  overlay.onclick = (e)=>{ if(e.target === overlay) overlay.style.display="none"; };
  document.addEventListener("keydown", function esc(ev){
    if(ev.key==="Escape" && overlay.style.display!=="none"){
      overlay.style.display="none";
      document.removeEventListener("keydown", esc);
    }
  });

  overlay.style.display = "flex";
}

/* Hooks : on r√©agit aux 2 cl√©s (local + global) */
window.addEventListener("DOMContentLoaded", ()=>{ setTimeout(()=>renderMailOverlay(), 200); });
window.addEventListener("focus", ()=>renderMailOverlay());
window.addEventListener("pageshow", ()=>renderMailOverlay());
window.addEventListener("storage",(e)=>{
  try{
    const ctx = mailCtx(); if(!ctx) return;
    if(e.key === ctx.keyLocal || e.key === ctx.keyGlobal){
      renderMailOverlay();
    }
  }catch(_){}
});
</script>



<script>
/* Menu mobile : ouvre/ferme les sous-menus au clic */
(function(){
  const nav = document.querySelector('nav.menu-bar');
  if (!nav) return;

  function isMobile() {
    return window.matchMedia('(max-width: 768px)').matches;
  }

  nav.addEventListener('click', function(e){
    const link = e.target.closest('li > a');
    if (!link || !isMobile()) return;

    const li = link.parentElement;
    const submenu = li.querySelector('ul');
    if (!submenu) {
      // Pas de sous-menu ‚Üí on laisse le lien se comporter normalement
      return;
    }

    // Il y a un sous-menu ‚Üí on ne suit pas le lien, on ouvre/ferme
    e.preventDefault();

    const alreadyOpen = li.classList.contains('open');

    // Ferme les autres sous-menus
    nav.querySelectorAll('li.open').forEach(el => {
      if (el !== li) el.classList.remove('open');
    });

    // Bascule l'√©tat du sous-menu cliqu√©
    if (alreadyOpen) {
      li.classList.remove('open');
    } else {
      li.classList.add('open');
    }
  });
})();
</script>

<script>
function loadChatbaseWidgetForAdmins() {
  // üîê On limite le widget aux admins / commandement / admin du centre
  if (!isAdmin() && !isSuperAdmin()) {
    return; // Pas admin ‚Üí on ne charge pas Chatbase
  }

  // Code d'int√©gration Chatbase tel que fourni
  (function(){
    if (!window.chatbase || window.chatbase("getState") !== "initialized") {
      window.chatbase = (...arguments) => {
        if (!window.chatbase.q) { window.chatbase.q = []; }
        window.chatbase.q.push(arguments);
      };
      window.chatbase = new Proxy(window.chatbase, {
        get(target, prop) {
          if (prop === "q") { return target.q; }
          return (...args) => target(prop, ...args);
        }
      });
    }

    const onLoad = function() {
      const script = document.createElement("script");
      script.src = "https://www.chatbase.co/embed.min.js";
      script.id = "zVqCo-pyQDmi3XjItI7CQ";
      script.domain = "www.chatbase.co";
      document.body.appendChild(script);
    };

    if (document.readyState === "complete") {
      onLoad();
    } else {
      window.addEventListener("load", onLoad);
    }
  })();
}

// üëâ On attend que la page soit pr√™te, puis on v√©rifie le r√¥le
window.addEventListener("DOMContentLoaded", loadChatbaseWidgetForAdmins);
</script>

<script>
/* ===========================
   üìÖ Agenda mensuel + r√©servations v√©hicules
   =========================== */
(function(){
  const monthLabel = document.getElementById("agenda-month-label");
  const grid       = document.getElementById("agenda-grid");
  const btnPrev    = document.getElementById("agenda-prev");
  const btnNext    = document.getElementById("agenda-next");
  const details    = document.getElementById("agenda-details");

  // üëâ √©l√©ments de la modale agenda
  const agendaModal      = document.getElementById("agenda-modal");
  const agendaModalTitle = document.getElementById("agenda-modal-title");
  const agendaModalBody  = document.getElementById("agenda-modal-body");
  const agendaModalClose = document.getElementById("agenda-modal-close");

  if (!monthLabel || !grid) return; // s√©curit√©

  const monthNames = [
    "Janvier","F√©vrier","Mars","Avril","Mai","Juin",
    "Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"
  ];

  // On se cale sur le 1er du mois courant
  let currentMonth = new Date();
  currentMonth.setDate(1);

  /* ----- Helpers pour r√©cup√©rer les r√©servations du CIS courant ----- */

  function getCurrentCis(){
    try{
      const session = JSON.parse(localStorage.getItem("csver_session") || "null");
      if(!session) return null;
      return Array.isArray(session.cis) ? session.cis[0] : session.cis;
    }catch(_){ return null; }
  }

  // Accepte soit un tableau, soit un objet { "0": {...}, "1": {...} }
  function rawToArray(raw){
    if(Array.isArray(raw)) return raw;
    if(raw && typeof raw === "object"){
      const keys = Object.keys(raw);
      if(keys.length && keys.every(k => /^\d+$/.test(k))){
        return keys.sort((a,b)=>Number(a)-Number(b)).map(k => raw[k]);
      }
    }
    return [];
  }

  // Renvoie un objet { "YYYY-MM-DD": [ r√©servations ce jour ] } pour le mois affich√©
  function buildReservationMap(year, monthIndex){
    const cisSel = getCurrentCis();
    if(!cisSel) return {};

    const keyRes = "reservations_" + cisSel;
    let raw;
    try{
      raw = JSON.parse(localStorage.getItem(keyRes) || "[]");
    }catch(_){
      raw = [];
    }
    const arr = rawToArray(raw);

    const map = {};
    const monthStart = new Date(year, monthIndex, 1);
    const monthEnd   = new Date(year, monthIndex + 1, 0);

    arr.forEach(r=>{
      if(!r) return;

      const status = r.status || "pending";
      // üëâ on colore / affiche uniquement les r√©servations ACCEPT√âES
      if(status !== "approved") return;

      const dStartStr = r.dateDebut || r.date;
      const dEndStr   = r.dateFin   || r.dateDebut || r.date;
      if(!dStartStr) return;

      const dStart = new Date(dStartStr + "T00:00:00");
      const dEnd   = new Date((dEndStr || dStartStr) + "T00:00:00");
      if(isNaN(dStart) || isNaN(dEnd)) return;

      let d = new Date(Math.max(dStart.getTime(), monthStart.getTime()));
      const limit = Math.min(dEnd.getTime(), monthEnd.getTime());

      while(d.getTime() <= limit){
        const y  = d.getFullYear();
        const m  = d.getMonth();
        const dd = d.getDate();
        const key = `${y}-${String(m+1).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;

        if(!map[key]) map[key] = [];
        map[key].push({
          dateKey: key,
          h1: r.h1 || "",
          h2: r.h2 || "",
          vehicule: r.vehicule || "",
          agent: r.agent || "",
          motif: r.motif || "",
          destination: r.destination || "",
          status: status
        });

        d.setDate(d.getDate() + 1);
      }
    });

    return map;
  }

   // Renvoie un objet { "YYYY-MM-DD": [ consignes de ce jour ] }
function buildConsigneMap(year, monthIndex){
  const cisSel = getCurrentCis();
  if (!cisSel) return {};

  const keyCons = "consignes_" + cisSel;
  let arr;
  try{
    arr = JSON.parse(localStorage.getItem(keyCons) || "[]");
    if (!Array.isArray(arr)) arr = [];
  }catch(_){
    arr = [];
  }

  const map = {};
  const monthStart = new Date(year, monthIndex, 1);
  const monthEnd   = new Date(year, monthIndex + 1, 0);

  function addOccurence(dateObj, consigne){
    const y  = dateObj.getFullYear();
    const m  = dateObj.getMonth();
    const dd = dateObj.getDate();
    const key = `${y}-${String(m+1).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;

    if (!map[key]) map[key] = [];
    map[key].push(consigne);
  }

  arr.forEach(c => {
    if (!c || c.cis !== cisSel) return;

    const dStartStr = (c.dateDebut || "").trim();
    if (!dStartStr) return;
    const dEndStr   = (c.dateFin || dStartStr).trim();

    const dStart = new Date(dStartStr + "T00:00:00");
    const dEnd   = new Date(dEndStr   + "T00:00:00");
    if (isNaN(dStart) || isNaN(dEnd)) return;

    const rec = c.recurrence || "once";
    const per = parseInt(c.periodicite, 10) || 1;

    // üîπ Cas "Ponctuelle" : comportement actuel = tous les jours entre d√©but et fin
    if (rec === "once"){
      let d = new Date(Math.max(dStart.getTime(), monthStart.getTime()));
      const limit = Math.min(dEnd.getTime(), monthEnd.getTime());

      while (d.getTime() <= limit){
        addOccurence(d, c);
        d.setDate(d.getDate() + 1);
      }
      return;
    }

    // üìÖ Pour les r√©currences, dateFin = derni√®re occurrence possible
    const globalEnd = Math.min(dEnd.getTime(), monthEnd.getTime());

    // Helper pour avancer √† la premi√®re occurrence >= monthStart
    function alignToMonthStart(stepFn){
      let occ = new Date(dStart.getTime());
      while (occ.getTime() < monthStart.getTime()){
        occ = stepFn(occ);
      }
      return occ;
    }

    if (rec === "daily"){
      const stepDays = per;

      let occ = alignToMonthStart(d => {
        const n = new Date(d.getTime());
        n.setDate(n.getDate() + stepDays);
        return n;
      });

      while (occ.getTime() <= globalEnd){
        addOccurence(occ, c);
        occ.setDate(occ.getDate() + stepDays);
      }
      return;
    }

    if (rec === "weekly"){
      const stepDays = 7 * per;

      let occ = alignToMonthStart(d => {
        const n = new Date(d.getTime());
        n.setDate(n.getDate() + stepDays);
        return n;
      });

      while (occ.getTime() <= globalEnd){
        addOccurence(occ, c);
        occ.setDate(occ.getDate() + stepDays);
      }
      return;
    }

    if (rec === "monthly" || rec === "yearly"){
      const baseDay = dStart.getDate();
      const stepMonths = (rec === "monthly") ? per : 12 * per;

      let occ = new Date(dStart.getTime());
      while (occ.getTime() < monthStart.getTime()){
        occ = new Date(occ.getFullYear(), occ.getMonth() + stepMonths, baseDay);
      }

      while (occ.getTime() <= globalEnd){
        // si le changement de mois d√©place le jour (ex: 31 ‚Üí 30), on accepte tel quel
        addOccurence(occ, c);
        occ = new Date(occ.getFullYear(), occ.getMonth() + stepMonths, baseDay);
      }
      return;
    }

    // S√©curit√© : si type inconnu -> comportement "plein" comme avant
    let d = new Date(Math.max(dStart.getTime(), monthStart.getTime()));
    const limit = Math.min(dEnd.getTime(), monthEnd.getTime());
    while (d.getTime() <= limit){
      addOccurence(d, c);
      d.setDate(d.getDate() + 1);
    }
  });

  return map;
}


  
  function formatDateFR(dateKey){
    const p = String(dateKey||"").split("-");
    if(p.length !== 3) return dateKey || "";
    return `${p[2]}/${p[1]}/${p[0]}`;
  }

    /* ----- Ouverture / fermeture de la modale agenda ----- */
    function importanceToColor(imp){
    switch(imp){
      case "haute":   return "#d32f2f"; // rouge
      case "moyenne": return "#fb8c00"; // orange
      case "faible":  return "#1976d2"; // bleu
      default:        return "#1976d2";
    }
  }
  function importanceToLabel(imp){
    switch(imp){
      case "haute":   return "Importante";
      case "moyenne": return "Moyenne";
      case "faible":  return "Faible";
      default:        return "‚Äî";
    }
  }
  function validiteLabel(v){
    switch(v){
      case "jour": return "Jour";
      case "nuit": return "Nuit";
      case "24h":  return "24h";
      default:     return "‚Äî";
    }
  }
  function serviceLabel(s){
    switch(s){
      case "commandement":  return "Commandement";
      case "officier":      return "Officier de garde";
      case "sous-officier": return "Sous-officier de garde";
      default:              return s || "Service";
    }
  }

  /* ----- Ouverture / fermeture de la modale agenda ----- */
  function openAgendaModal(dateKey, resList, consList){
    if(!agendaModal || !agendaModalTitle || !agendaModalBody) return;

    const label = dateKey ? formatDateFR(dateKey) : "";
    agendaModalTitle.textContent = label
      ? `üìÖ D√©tails du ${label}`
      : "üìÖ D√©tails du jour";

    let html = "";

    /* üìå CONSIGNES EN HAUT */
   if (consList && consList.length){
    // üëâ tri par importance : rouge (haute), orange (moyenne), bleu (faible)
    const orderImp = { haute: 0, moyenne: 1, faible: 2 };

    const sortedCons = [...consList].sort((a, b) => {
      const ia = orderImp[a.importance] ?? 99;
      const ib = orderImp[b.importance] ?? 99;
      if (ia !== ib) return ia - ib;

      // tri secondaire : par titre (optionnel)
      return (a.titre || "").localeCompare(b.titre || "", "fr", {sensitivity:"base"});
    });

    html += `
      <div class="agenda-modal-section">
        <div class="agenda-modal-title-sub">üìå Consignes du jour</div>
    `;

    sortedCons.forEach(c => {
  const color  = importanceToColor(c.importance);
  const vLab   = validiteLabel(c.validite);
  const impLab = importanceToLabel(c.importance);
  const serv   = serviceLabel(c.serviceOrigine);

  // üëâ nom de l‚Äôagent qui a cr√©√© la consigne
  const auteur =
    (c.createdBy && (c.createdBy.display || c.createdBy.nom || c.createdBy.matricule)) || "";

  html += `
    <div class="agenda-consigne-card">
      <div class="agenda-consigne-title">
        <span class="agenda-consigne-dot" style="background:${color};"></span>
        ${escapeHtml(c.titre || "Consigne")}
      </div>
      <div class="agenda-consigne-body">
        ${escapeHtml(c.contenu || "")}
      </div>
      <div class="agenda-consigne-meta">
        Validit√© : ${escapeHtml(vLab)}
        ‚Äî Origine : ${escapeHtml(serv)}
        ‚Äî Importance : ${escapeHtml(impLab)}
        ${auteur ? " ‚Äî Cr√©√©e par : " + escapeHtml(auteur) : ""}
      </div>
    </div>
  `;
});


    html += `</div>`;
  }

    /* üöò R√âSERVATIONS EN BAS */
    if(resList && resList.length){
      html += `
        <div class="agenda-modal-section">
          <div class="agenda-modal-title-sub">üöò R√©servations v√©hicules</div>
          <div class="agenda-modal-table-wrapper">
            <table class="agenda-modal-table">
              <thead>
                <tr>
                  <th>Date / jour</th>
                  <th>Heures</th>
                  <th>V√©hicule</th>
                  <th>Agent</th>
                  <th>Motif</th>
                  <th>Destination</th>
                </tr>
              </thead>
              <tbody>
      `;

      html += resList.map(r => `
        <tr>
          <td>${formatDateFR(r.dateKey || dateKey)}</td>
          <td>${escapeHtml((r.h1 || "--") + (r.h2 ? "‚Äì" + r.h2 : ""))}</td>
          <td>${escapeHtml(r.vehicule || "‚Äî")}</td>
          <td>${escapeHtml(r.agent || "‚Äî")}</td>
          <td>${escapeHtml(r.motif || "‚Äî")}</td>
          <td>${escapeHtml(r.destination || "‚Äî")}</td>
        </tr>
      `).join("");

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    if(!html){
      html = `
        <div style="padding:10px;color:#666;font-size:13px;">
          Aucune consigne ni r√©servation pour ce jour.
        </div>
      `;
    }

    agendaModalBody.innerHTML = html;
    agendaModal.style.display = "flex";
  }


  function closeAgendaModal(){
    if(agendaModal) agendaModal.style.display = "none";
  }

  if(agendaModalClose){
    agendaModalClose.addEventListener("click", closeAgendaModal);
  }
  if(agendaModal){
    agendaModal.addEventListener("click", function(e){
      if(e.target === agendaModal) closeAgendaModal();
    });
    document.addEventListener("keydown", function esc(e){
      if(e.key === "Escape" && agendaModal.style.display !== "none"){
        closeAgendaModal();
      }
    });
  }

  /* ----- Rendu du calendrier ----- */
  function renderAgenda(){
    grid.innerHTML = "";

    // Texte fixe sous le calendrier (on n'y met plus les d√©tails)
   if(details){
  details.innerHTML = "";   // on laisse vide
}

    const year  = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    const firstDay = new Date(year, month, 1);
    const lastDay  = new Date(year, month + 1, 0);
    const daysInMonth   = lastDay.getDate();
    const startWeekday  = (firstDay.getDay() + 6) % 7; // Lun=0 ... Dim=6

            monthLabel.textContent = monthNames[month] + " " + year;

    const resMap  = buildReservationMap(year, month);
    const consMap = buildConsigneMap(year, month);


    // Cases vides avant le 1er
    for(let i=0; i<startWeekday; i++){
      const cell = document.createElement("div");
      cell.className = "agenda-cell agenda-cell-empty";
      grid.appendChild(cell);
    }

    const today = new Date();
    const isSameMonth =
      today.getFullYear() === year &&
      today.getMonth()    === month;

           // Jours du mois
    for(let d=1; d<=daysInMonth; d++){
      const cell = document.createElement("div");
      cell.className = "agenda-cell";
      cell.textContent = d;

      const dateKey =
        `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const dayRes      = resMap[dateKey]  || [];
      const dayCons     = consMap[dateKey] || [];
      const hasConsigne = dayCons.length > 0;

      if (isSameMonth && d === today.getDate()){
        cell.classList.add("agenda-today");
      }
      // üîµ couleur si r√©servation APPROUV√âE OU consigne ce jour-l√†
      if (dayRes.length || hasConsigne){
        cell.classList.add("agenda-event");
      }

      // On ouvre la modale avec r√©servations + consignes
      cell.addEventListener("click", function(){
        openAgendaModal(dateKey, dayRes, dayCons);
      });

      grid.appendChild(cell);
    }

  }


  
  btnPrev && btnPrev.addEventListener("click", function(){
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderAgenda();
  });

  btnNext && btnNext.addEventListener("click", function(){
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderAgenda();
  });

  // Expose une fonction globale si tu veux forcer un refresh plus tard
  window.refreshAgendaCalendar = renderAgenda;


})();
</script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const btnPrint = document.getElementById("btn-print-anom");
  const formationHeader = document.getElementById("formation-header");

  if (!btnPrint || !formationHeader) return;

  // Renommage
  btnPrint.textContent = "üñ®Ô∏è Imprimer";

  // D√©placement SANS casser le layout
  formationHeader.appendChild(btnPrint);

  // Ajustement l√©ger pour qu‚Äôil ne colle pas
  btnPrint.style.marginLeft = "8px";
});
</script>


<!-- FIN AJOUT -->

</body>
</html>
